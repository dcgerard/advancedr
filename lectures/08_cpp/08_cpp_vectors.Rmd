---
title: "C++ Vectors"
author: "David Gerard"
date: "`r Sys.Date()`"
output:  
  html_document:
    toc: true
    toc_depth: 4
    toc_float: false
    highlight: pygments
urlcolor: "blue"
bibliography: "08_bib.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo       = TRUE, 
                      fig.align  = "center",
                      fig.height = 3, fig.width = 4)
ggplot2::theme_set(ggplot2::theme_bw() + ggplot2::theme(strip.background = ggplot2::element_rect(fill = "white")))
```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy()
```

```{Rcpp, ref.label=knitr::all_rcpp_labels(), include=FALSE}
```

```{Rcpp, eval = FALSE, echo = FALSE}
#include <Rcpp.h>
using namespace Rcpp;
```

# Learning Objectives

- Chapters 8 and 10 of [Rcpp for Everyone](https://teuder.github.io/rcpp4everyone_en/)
- Chapter 25 of [Advanced R](https://adv-r.hadley.nz/rcpp.html)
- [Rcpp Quick Reference Guide](https://dirk.eddelbuettel.com/code/rcpp/Rcpp-quickref.pdf)
- Learning Objectives:
    - Rcpp Vectors
    - For-loops
    - Basic Vector Operations

# Rcpp Vectors

- `{Rcpp}` provides classes of C++ vectors which make programming easier for folks used to R.

- The classes are called `LogicalVector`, `IntegerVector`, `NumericVector`, and `CharacterVector`.

- Note, in non Rcpp C++, you typically use `std::vector` objects, like `std::vector<double>`.

- If you have a function that accepts and returns vectors, then you use those types.

    ``` cpp
    NumericVector fn(IntegerVector x, bool y) {
      // code to create z
      return z;
    }
    ```

# Creating Vectors

- You create an empty vector of length `n` with

    ``` cpp
    NumericVector x(n);
    ```

- You can add default values by including a second argument via

    ``` cpp
    NumericVector x(n, 2.0);
    ```
    
- If you want an `IntegerVector` from `0` to `n - 1`, probably the best way is through `std::iota()`

    ``` cpp
    IntegerVector x(n);
    std::iota(x.begin(), x.end(), 0);
    ```

- If you have specific elements you want to create the vector with, use curly braces (requires C++11):

    ``` cpp
    NumericVector x = {9.0, 1.2, 4.9};
    ```
    
- For older versions of C++, use `NumericVector::create()`.

    ``` cpp
    NumericVector x = NumericVector::create(9.0, 1.2, 4.9);
    ```

- Let's demonstrate these methods
    ```{Rcpp, eval = FALSE}
    // [[Rcpp::export]]
    void vec_create() {
      int n = 5;
      
      NumericVector x1(n);
      
      NumericVector x2(n, 2.0);
      
      CharacterVector x3(n, "A");
      
      IntegerVector x4(n);
      std::iota(x4.begin(), x4.end(), 0);
      
      NumericVector x5 = {9.0, 1.2, 4.9};
      
      NumericVector x6 = NumericVector::create(9.0, 1.2, 4.9);
      
      Rcpp::Rcout << "x1: " << x1 << std::endl
                  << "x2: " << x2 << std::endl
                  << "x3: " << x3 << std::endl
                  << "x4: " << x4 << std::endl
                  << "x5: " << x5 << std::endl
                  << "x6: " << x6 << std::endl;
    }
    ```
    
    ```{r}
    vec_create()
    ```

# Accessing Elements

- You get and set individual elements of a vector using brackets `[]`, just like in R.

- Note that in C++, **indexing starts at 0**.

- One more time for emphasis, in **C++ indexing starts at 0**.

    ```{Rcpp, eval = FALSE}
    // [[Rcpp::export]]
    void subset_example(NumericVector x) {
      Rcpp::Rcout << "x[0]:" << x[0] << std::endl
                  << "x[1]:" << x[1] << std::endl
                  << "x[2]:" << x[2] << std::endl;
                  
      x[0] = 21;
      x[1] = 22;
      x[2] = 23;
      
      Rcpp::Rcout << "x[0]:" << x[0] << std::endl
                  << "x[1]:" << x[1] << std::endl
                  << "x[2]:" << x[2] << std::endl;
    }
    ```
    
    ```{r}
    subset_example(c(14, 38, 29))
    ```

# Rcpp Vector Methods

- A **method** is a function that is attached to an object. In C++, methods are accessed with a `.` (just like python).

- Rcpp vectors have a lot of useful methods.

- `length()`

- `fill()`

- `sort()`

- `push_back()`

- `push_front()`

- `begin()` and `end()` returns iterators pointing to the first and last elements of the vector (we'll talk about this later)


# For-loops

- All for-loops in C++ are of the form

    ``` cpp
    for (s1; s2; s3) {
      // code executed each iteration
    }
    ```

    - `s1` is code that is executed once before the for-loop.
    - `s2` is a predicate that, when `true`, allows the for-loop to execute another iteration.
    - `s3` is code that is evaluated at the end of each for-loop.
    
- Almost all for-loops you write will look like this

    ``` cpp
    for (int i = 0; i < n; i++) {
    
    }
    ```

    - We define `i` as an integer, initializing it to be `0`.
    - We only exit the for-loop if `i >= n`.
    - At the end of each iteration we add `1` to `i`.
    
- **Exercise**: In the above for-loop, if `n = 10`, how many iterations will of the for-loop will run, 9 or 10?
    ```{block, eval = FALSE, echo = FALSE}
    10, because we start at 0.
    ```

# Exercises

1. (from Advanced R) For each of the following functions, read the code and figure out what the corresponding base R function is. You might not understand every part of the code yet, but you should be able to figure out the basics of what the function does.

    ``` cpp
    double f1(NumericVector x) {
      int n = x.size();
      double y = 0;
    
      for(int i = 0; i < n; ++i) {
        y += x[i] / n;
      }
      return y;
    }
    
    NumericVector f2(NumericVector x) {
      int n = x.size();
      NumericVector out(n);
    
      out[0] = x[0];
      for(int i = 1; i < n; ++i) {
        out[i] = out[i - 1] + x[i];
      }
      return out;
    }
    
    bool f3(LogicalVector x) {
      int n = x.size();
    
      for(int i = 0; i < n; ++i) {
        if (x[i]) return true;
      }
      return false;
    }
    
    int f4(Function pred, List x) {
      int n = x.size();
    
      for(int i = 0; i < n; ++i) {
        LogicalVector res = pred(x[i]);
        if (res[0]) return i + 1;
      }
      return 0;
    }
    
    NumericVector f5(NumericVector x, NumericVector y) {
      int n = std::max(x.size(), y.size());
      NumericVector x1 = rep_len(x, n);
      NumericVector y1 = rep_len(y, n);
    
      NumericVector out(n);
    
      for (int i = 0; i < n; ++i) {
        out[i] = std::min(x1[i], y1[i]);
      }
    
      return out;
    }
    ```

2. (from Advanced R) Convert the following functions into C++. For now, assume the inputs have no missing values.
    1. `all()`.
    2. `cumprod()`, `cummin()`, `cummax()`.
    3. `diff()`. Start by assuming lag 1, and then generalize for lag n.
    4. `range()`.
    5. `var()`. Read about the approaches you can take on Wikipedia. Whenever implementing a numerical algorithm, itâ€™s always good to check what is already known about the problem.

3. Create a function in C++ call `fib()` that will take as input `n` and return the first `n` [Fibonacci numbers](https://en.wikipedia.org/wiki/Fibonacci_number), where the sequence begins with 0, 1, 1, 2, 3, 5, 8, 13, ...








