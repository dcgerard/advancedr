<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="David Gerard" />

<meta name="date" content="2022-02-08" />

<title>Environments</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link rel="shortcut icon" href="https://dcgerard.github.io/advancedr/au_logo_small.png" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Teaching Website for Advanced R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="data.html">Data</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/dcgerard/advancedr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Environments</h1>
<h4 class="author">David Gerard</h4>
<h4 class="date">2022-02-08</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#environment-basics">Environment Basics</a></li>
<li><a href="#parents">Parents</a></li>
<li><a href="#working-with-objects-in-an-environment">Working with Objects in an Environment</a></li>
<li><a href="#hadleys-advanced-r-exercises">Hadley’s Advanced R Exercises</a></li>
<li><a href="#loop-through-environments">Loop through environments</a></li>
<li><a href="#special-environments">Special Environments</a>
<ul>
<li><a href="#package-environments.">Package environments.</a></li>
<li><a href="#function-environment">Function Environment</a></li>
<li><a href="#namespaces">Namespaces</a></li>
<li><a href="#execution-environments">Execution Environments</a></li>
<li><a href="#caller-environment">Caller Environment</a></li>
</ul></li>
<li><a href="#applications">Applications</a>
<ul>
<li><a href="#numeric-derivatives">Numeric Derivatives</a></li>
<li><a href="#managing-state">Managing State</a></li>
</ul></li>
<li><a href="#r6-objects">R6 Objects</a></li>
<li><a href="#hashing">Hashing</a></li>
<li><a href="#new-functions">New Functions</a></li>
</ul>
</div>

<script>
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('left', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<div id="learning-objectives" class="section level1">
<h1>Learning Objectives</h1>
<ul>
<li>R Environments</li>
<li>Chapter 7 from <a href="https://adv-r.hadley.nz/">Advanced R</a>
<ul>
<li>These lecture notes are mostly taken straight out of Hadley’s book. Many thanks for making my life easier.</li>
<li>His images, which I use here, are licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" height="15" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/></a></li>
</ul></li>
</ul>
</div>
<div id="environment-basics" class="section level1">
<h1>Environment Basics</h1>
<ul>
<li><p>Hadley and colleagues made a really great package that, among other things, allows for handling environments: <code>{rlang}</code>. It’s way better than the base R functionality.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span></code></pre></div></li>
<li><p>An <strong>environment</strong> is a fundamental data object in R that determines lexical scoping — i.e. they determine when a name is bound to an object.</p></li>
<li><p>Motivations:</p>
<ul>
<li>Environments are used to make functions self-contained.</li>
<li>Environments are used to separate functions of the same name in different packages.</li>
<li>Environments are used in some object oriented programming systems in R.</li>
</ul></li>
<li><p>An environment is like a list, except:</p>
<ul>
<li>Every name must be unique.
<ul>
<li>Lists can have multiple elements of the same name.</li>
</ul></li>
<li>Names are not ordered.
<ul>
<li>Lists are ordered.</li>
</ul></li>
<li>All environments (except the empty environment) have “parent” environments that they live in.</li>
<li>Environments use modify-in-place semantics.
<ul>
<li>Lists are copy-on-modify.</li>
</ul></li>
</ul></li>
<li><p>Create a new environment with <code>rlang::env()</code>, which behaves a lot list <code>list()</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>e1 <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">env</span>(<span class="at">a =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">b =</span> <span class="st">&quot;a&quot;</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">c =</span> <span class="fl">2.3</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">d =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span></code></pre></div></li>
<li><p>Environments associate names to values without any particular order. Hadley draws them like this:</p>
<p><img src="04_figs_env/bindings.png" alt="Environment Bindings" width="40%"/></p>
<ul>
<li><p>Above, the arrows indicate “bindings”. So <code>b</code> is bound to <code>"a"</code> and <code>a</code> is bound to <code>FALSE</code>, etc…</p></li>
<li><p>The blue dot indicates the parent environment.</p></li>
</ul></li>
<li><p>Environments have “reference semantics”, which means that they modify-in-place.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>e2 <span class="ot">&lt;-</span> e1</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>e2<span class="sc">$</span>d <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>e1<span class="sc">$</span>d</span></code></pre></div>
<pre><code>## [1] 4 5 6</code></pre></li>
<li><p>An environment can contain itself.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>e1<span class="sc">$</span>d <span class="ot">&lt;-</span> e1</span></code></pre></div>
<p><img src="04_figs_env/loop.png" alt="Environment containing itself" width="40%"/></p></li>
<li><p>Printing an environment just shows its address in memory.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>e1</span></code></pre></div>
<pre><code>## &lt;environment: 0x5620fb4d5e08&gt;</code></pre></li>
<li><p>To print the objects of an environment, use <code>rlang::env_print()</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_print</span>(e1)</span></code></pre></div>
<pre><code>## &lt;environment: 0x5620fb4d5e08&gt;
## Parent: &lt;environment: global&gt;
## Bindings:
## • a: &lt;lgl&gt;
## • b: &lt;chr&gt;
## • c: &lt;dbl&gt;
## • d: &lt;env&gt;</code></pre></li>
<li><p>Use <code>rlang::env_names()</code> to get a character vector with names.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_names</span>(e1)</span></code></pre></div>
<pre><code>## [1] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot;</code></pre></li>
<li><p>The current environment is the environment in which the code is currently being executed (where R looks for names). Use <code>rlang::current_env()</code> to get the current environment.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ce <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">current_env</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(ce)</span></code></pre></div>
<pre><code>## [1] &quot;environment&quot;</code></pre></li>
<li><p>The global environment is the environment where you interactively use R. You can access it with <code>rlang::global_env()</code></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>gl <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">global_env</span>()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(gl)</span></code></pre></div>
<pre><code>## [1] &quot;environment&quot;</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">env_print</span>(gl)</span></code></pre></div>
<pre><code>## &lt;environment: global&gt;
## Parent: &lt;environment: package:rlang&gt;
## Bindings:
## • ce: &lt;env&gt;
## • e1: &lt;env&gt;
## • e2: &lt;env&gt;
## • gl: &lt;env&gt;</code></pre></li>
<li><p>We can see that the current environment is the global environment with <code>identical()</code></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(gl, ce)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre></li>
<li><p>You should not use <code>==</code>. This is since <code>==</code> is expecting to be used on a vector, and an environment is not a vector.</p></li>
</ul>
</div>
<div id="parents" class="section level1">
<h1>Parents</h1>
<ul>
<li><p>Every environment has a <strong>parent</strong>. If a name is not found in the current environment then it is searched for in the parent. This is how lexical scoping operates in R.</p></li>
<li><p><code>rlang::env()</code> actually creates a <strong>child</strong> environment. You can either supply the parent or it assumes the parent is the current environment.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>e2a <span class="ot">&lt;-</span> <span class="fu">env</span>(<span class="at">d =</span> <span class="dv">4</span>, <span class="at">e =</span> <span class="dv">5</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>e2b <span class="ot">&lt;-</span> <span class="fu">env</span>(e2a, <span class="at">a =</span> <span class="dv">1</span>, <span class="at">b =</span> <span class="dv">2</span>, <span class="at">c =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="04_figs_env/parents.png" alt="parent environments" width="40%"/></p></li>
<li><p>In the above diagram, the pale blue dot represents a pointer to the parent. The left box is the child and the right box is the parent.</p></li>
<li><p><code>rlang::env_parent()</code> gives you the parent.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">env_parent</span>(e2b)</span></code></pre></div>
<pre><code>## &lt;environment: 0x5620fdc3ce30&gt;</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>e2a</span></code></pre></div>
<pre><code>## &lt;environment: 0x5620fdc3ce30&gt;</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">env_parent</span>(e2a)</span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre></li>
<li><p>Every environment has as an ancestor the empty environment, which has no parent. You can access it with <code>rlang::empty_env()</code></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>em <span class="ot">&lt;-</span> <span class="fu">empty_env</span>()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_print</span>(em)</span></code></pre></div>
<pre><code>## &lt;environment: empty&gt;
## Parent: NULL</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_parents</span>(em)</span></code></pre></div>
<pre><code>## list()</code></pre></li>
<li><p>We can make children of the empty environment with <code>rlang::env()</code> by including the empty environment as the first argument.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>e2c <span class="ot">&lt;-</span> <span class="fu">env</span>(<span class="fu">empty_env</span>(), <span class="at">d =</span> <span class="dv">4</span>, <span class="at">e =</span> <span class="dv">5</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>e2d <span class="ot">&lt;-</span> <span class="fu">env</span>(e2c, <span class="at">a =</span> <span class="dv">1</span>, <span class="at">b =</span> <span class="dv">2</span>, <span class="at">c =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="04_figs_env/parents-empty.png" alt="parent environment is now empty" width="40%"/></p></li>
<li><p>Your global environment has the empty environment as the progentor.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_parents</span>(rlang<span class="sc">::</span><span class="fu">global_env</span>())</span></code></pre></div>
<pre><code>##  [[1]] $ &lt;env: package:rlang&gt;
##  [[2]] $ &lt;env: package:stats&gt;
##  [[3]] $ &lt;env: package:graphics&gt;
##  [[4]] $ &lt;env: package:grDevices&gt;
##  [[5]] $ &lt;env: package:utils&gt;
##  [[6]] $ &lt;env: package:datasets&gt;
##  [[7]] $ &lt;env: package:methods&gt;
##  [[8]] $ &lt;env: Autoloads&gt;
##  [[9]] $ &lt;env: package:base&gt;
## [[10]] $ &lt;env: empty&gt;</code></pre></li>
<li><p>The ancestors of the global environment are all of the attached packages that ultimately terminate in the empty environment. So <code>env_parents()</code> will stop at the global environment by default.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>et <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_parents</span>(et)</span></code></pre></div>
<pre><code>## [[1]] $ &lt;env: global&gt;</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_parents</span>(et, <span class="at">last =</span> rlang<span class="sc">::</span><span class="fu">empty_env</span>())</span></code></pre></div>
<pre><code>##  [[1]] $ &lt;env: global&gt;
##  [[2]] $ &lt;env: package:rlang&gt;
##  [[3]] $ &lt;env: package:stats&gt;
##  [[4]] $ &lt;env: package:graphics&gt;
##  [[5]] $ &lt;env: package:grDevices&gt;
##  [[6]] $ &lt;env: package:utils&gt;
##  [[7]] $ &lt;env: package:datasets&gt;
##  [[8]] $ &lt;env: package:methods&gt;
##  [[9]] $ &lt;env: Autoloads&gt;
## [[10]] $ &lt;env: package:base&gt;
## [[11]] $ &lt;env: empty&gt;</code></pre></li>
</ul>
</div>
<div id="working-with-objects-in-an-environment" class="section level1">
<h1>Working with Objects in an Environment</h1>
<ul>
<li><p>Regular assignment <code>&lt;-</code> creates a variable in the current environment.</p></li>
<li><p>Super assignment <code>&lt;&lt;-</code> modifies an existing variable found in the parent environment. If no such variable exists, it creates one in the global environment.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;&lt;-</span> <span class="dv">1</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>()</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## [1] 1</code></pre></li>
<li><p>Most of the time, it is not a good idea to use super assignment. Global variables are vary dangerous. We’ll talk about one good application of them in Chapter 10.</p></li>
<li><p>Get and set values from an environment the same way as from a list.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>e3 <span class="ot">&lt;-</span> <span class="fu">env</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="dv">2</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>e3<span class="sc">$</span>x</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>e3[[<span class="st">&quot;x&quot;</span>]]</span></code></pre></div>
<pre><code>## [1] 1</code></pre></li>
<li><p>Because environments are unordered, integer subsetting does not work</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>e3[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## Error in e3[[1]]: wrong arguments for subsetting an environment</code></pre></li>
<li><p>Because environments are not vectors, you cannot use sing brackets <code>[]</code>, so you cannot get more than one element.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>e3[<span class="st">&quot;x&quot;</span>]</span></code></pre></div>
<pre><code>## Error in e3[&quot;x&quot;]: object of type &#39;environment&#39; is not subsettable</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>e3[<span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)]</span></code></pre></div>
<pre><code>## Error in e3[c(&quot;x&quot;, &quot;y&quot;)]: object of type &#39;environment&#39; is not subsettable</code></pre></li>
<li><p>You get <code>NULL</code> if a variable is not in an environment, just like a list:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>e3<span class="sc">$</span>z</span></code></pre></div>
<pre><code>## NULL</code></pre></li>
<li><p>Test if an environment has a binding with <code>rlang::env_has()</code></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_has</span>(e3, <span class="st">&quot;x&quot;</span>)</span></code></pre></div>
<pre><code>##    x 
## TRUE</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_has</span>(e3, <span class="st">&quot;z&quot;</span>)</span></code></pre></div>
<pre><code>##     z 
## FALSE</code></pre></li>
<li><p>Unlike a list, you do not remove elements by assigning them to <code>NULL</code>, because the name refers to <code>NULL</code>.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>e3<span class="sc">$</span>a <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>e3<span class="sc">$</span>a <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>e3<span class="sc">$</span>a</span></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_has</span>(e3, <span class="st">&quot;a&quot;</span>)</span></code></pre></div>
<pre><code>##    a 
## TRUE</code></pre></li>
<li><p>Use <code>rlang::env_unbind()</code> to remove an object.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_unbind</span>(e3, <span class="st">&quot;a&quot;</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_has</span>(e3, <span class="st">&quot;a&quot;</span>)</span></code></pre></div>
<pre><code>##     a 
## FALSE</code></pre></li>
</ul>
</div>
<div id="hadleys-advanced-r-exercises" class="section level1">
<h1>Hadley’s Advanced R Exercises</h1>
<ol style="list-style-type: decimal">
<li><p>Create an environment as illustrated by this picture.</p>
<p><img src="04_figs_env/recursive-1.png" alt="recursive" width="20%"/></p></li>
<li><p>Create a pair of environments as illustrated by this picture.</p>
<p><img src="04_figs_env/recursive-2.png" alt="recursive" width="35%"/></p></li>
</ol>
</div>
<div id="loop-through-environments" class="section level1">
<h1>Loop through environments</h1>
<ul>
<li><p>Sometimes, you want to look through all of the ancestor environments to find an object, or for exploration. Here is an example where we count how many objects are in each ancestral environment.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>count_env <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">base_env =</span> rlang<span class="sc">::</span><span class="fu">caller_env</span>(), </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">end_env =</span> rlang<span class="sc">::</span><span class="fu">empty_env</span>()) {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  nenv <span class="ot">&lt;-</span> <span class="fu">length</span>(rlang<span class="sc">::</span><span class="fu">env_parents</span>(<span class="at">env =</span> base_env, <span class="at">last =</span> end_env))</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  obj_num <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="at">length.out =</span> nenv)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  env <span class="ot">&lt;-</span> base_env</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(nenv)) {</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    obj_num[[i]] <span class="ot">&lt;-</span> <span class="fu">length</span>(env)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(obj_num)[[i]] <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">env_name</span>(env)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    env <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">env_parent</span>(env)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(obj_num)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="fu">count_env</span>()</span></code></pre></div>
<pre><code>##            global     package:rlang     package:stats  package:graphics 
##                14               434               456                88 
## package:grDevices     package:utils  package:datasets   package:methods 
##               119               221               104               371 
##         Autoloads      package:base 
##                 1              1370</code></pre></li>
<li><p>The caller environment is the environment of the function that called the current function. See below.</p></li>
</ul>
</div>
<div id="special-environments" class="section level1">
<h1>Special Environments</h1>
<ul>
<li><p>Most environments are created by R, not by you.</p></li>
<li><p>The most important ones are:</p>
<ul>
<li><p><strong>Global Environment</strong>: Environment that you, the user, interact with during an interactive session.</p></li>
<li><p><strong>Package Environment</strong>: External interface for a package. When you, the user, uses a function, it looks for it in the package environment.</p></li>
<li><p><strong>Namespace Environment</strong>: Internal interface for apackage. When the package searches for a function within the same package, it looks for it in the namespace environment.</p></li>
<li><p><strong>Imports Environment</strong>: Functions used by the package. When the package searches for a function from another package, it looks for it in the imports environment.</p></li>
<li><p><strong>Function Environment</strong> (aka enclosing environment): Environment where function was created and where it has access to objects. For a function from a package, this is the namespace environment. For a function you create during an interactive session, this is the global environment.</p></li>
<li><p><strong>Binding Environment</strong> of a function: Environment where the name of a function is bound to the function. May or may not be the same as the function environment.</p></li>
<li><p><strong>Execution Environment</strong>: Each time a function is called, a new temporary environment is created to host execution. This is to that function calls always have a “fresh start”</p></li>
<li><p><strong>Caller environment</strong>: The environment in which the function was called.</p></li>
</ul></li>
</ul>
<div id="package-environments." class="section level2">
<h2>Package environments.</h2>
<ul>
<li><p>Each package attached by <code>library()</code> creates a package environment that becomes an ancestor of the global environment. They are parents in the order that you attached them.</p>
<p><img src="04_figs_env/search-path.png" alt="recursive" width="70%"/></p></li>
<li><p>This order is called the <strong>search path</strong> because variable names are searched in that order. You can see the search path with <code>rlang::search_envs()</code>.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">search_envs</span>()</span></code></pre></div>
<pre><code>##  [[1]] $ &lt;env: global&gt;
##  [[2]] $ &lt;env: package:rlang&gt;
##  [[3]] $ &lt;env: package:stats&gt;
##  [[4]] $ &lt;env: package:graphics&gt;
##  [[5]] $ &lt;env: package:grDevices&gt;
##  [[6]] $ &lt;env: package:utils&gt;
##  [[7]] $ &lt;env: package:datasets&gt;
##  [[8]] $ &lt;env: package:methods&gt;
##  [[9]] $ &lt;env: Autoloads&gt;
## [[10]] $ &lt;env: package:base&gt;</code></pre></li>
<li><p>So if I try to evaluate a variable/function name, then it will first search for it in the global environment, then in the <code>{rlang}</code> package environment, then in the <code>{stats}</code> package environment, etc…</p></li>
<li><p>Attaching a new package with <code>library()</code> makes that package the immediate parent of the global environment.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(d)</span></code></pre></div>
<p><img src="04_figs_env/search-path-2.png" alt="recursive" width="70%"/></p></li>
</ul>
</div>
<div id="function-environment" class="section level2">
<h2>Function Environment</h2>
<ul>
<li><p>The <strong>function environment</strong> is the environment where the function has access to all objects in that environment and its parent environments. This is the current environment when the function is created, <strong>not</strong> when the function is called.</p></li>
<li><p>You can see the function environment via <code>rlang::fn_env()</code></p></li>
<li><p>The function environment may or may not be a new environment. E.g. most of the functions you write use the global environment as the function environment.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="dv">1</span><span class="sc">:</span>x)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">fn_env</span>(fn)</span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre></li>
<li><p>Above, since the function environment is the global environment, <code>fn()</code> has access to <code>x</code> (which is in the global environment) and to <code>sum()</code> (which is in the namespace:base environment).</p></li>
<li><p>Most functions in a package have the namespace environment (see below) as the function environment.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">fn_env</span>(base<span class="sc">::</span>sum)</span></code></pre></div>
<pre><code>## &lt;environment: namespace:base&gt;</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">fn_env</span>(stats<span class="sc">::</span>lm)</span></code></pre></div>
<pre><code>## &lt;environment: namespace:stats&gt;</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">fn_env</span>(rlang<span class="sc">::</span>fn_env)</span></code></pre></div>
<pre><code>## &lt;environment: namespace:rlang&gt;</code></pre></li>
<li><p>The function environment may or may not be different from the environment where the name is bound to the function. That space is called the <strong>binding environment</strong> of the function.</p></li>
<li><p>In many cases, the function environment is the same as the binding environment. Below, the name <code>f</code> in the global environment is bound to the function (arrow moving from f to the yellow object), so the binding environment is the global environment. Also below, the function is bound to the global environment (arrow moving from the black dot to the global environment), so the global environment has the objects that the function has access to, so the function environment is also the global environment.</p>
<p><img src="04_figs_env/binding.png" alt="recursive" width="40%"/></p></li>
<li><p>Below, the name <code>g</code> in the <code>e</code> environment was created in the global environment. So the function environment is the global environment. But the name <code>g</code> is in the <code>e</code> environment, so the binding environment is <code>e</code>.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">env</span>()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>e<span class="sc">$</span>g <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="dv">1</span></span></code></pre></div>
<p><img src="04_figs_env/binding-2.png" alt="recursive" width="40%"/></p></li>
<li><p><strong>Exercise</strong>: Does <code>g()</code> still have access to all of the objects in the global environment?</p></li>
</ul>
</div>
<div id="namespaces" class="section level2">
<h2>Namespaces</h2>
<ul>
<li><p>The <strong>package environment</strong> is the external interface for a package. It contains the exported functions of a package.</p></li>
<li><p>The <strong>namespace environment</strong> of a package is the internal interface for a package. Functions in the package will search for its objects in the namespace environment.</p></li>
<li><p>This is what allows us to modify (rather foolishly) <code>var()</code> but still allow <code>sd()</code> to work properly.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>sd</span></code></pre></div>
<pre><code>## function (x, na.rm = FALSE) 
## sqrt(var(if (is.vector(x) || is.factor(x)) x else as.double(x), 
##     na.rm = na.rm))
## &lt;bytecode: 0x5620fcd2cbf0&gt;
## &lt;environment: namespace:stats&gt;</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(x)</span></code></pre></div>
<pre><code>## [1] 0.6993</code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>var <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="dv">0</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">var</span>(x)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(x)</span></code></pre></div>
<pre><code>## [1] 0.6993</code></pre></li>
<li><p>The namespace environment acts as the function environment for all functions in a package.</p></li>
<li><p>An exported function has a binding both in the namespace environment and the package environment.</p>
<p><img src="04_figs_env/namespace-bind.png" alt="namespace vs packge environments" width="40%"/></p></li>
<li><p>An internal function only has a binding the namespace environment.</p></li>
<li><p>The parent of a namespace environment is an <strong>imports</strong> environment that contains bindings of all functions used by the package.</p></li>
<li><p>The parent of the imports environment is the base namespace, where all base functions are located (this is why you don’t need to import <code>sum()</code> or use <code>base::sum()</code> in your package code).</p></li>
<li><p>The parent of the base namespace is the global environment.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">env_parents</span>(<span class="fu">fn_env</span>(stats<span class="sc">::</span>var))</span></code></pre></div>
<pre><code>## [[1]] $ &lt;env: imports:stats&gt;
## [[2]] $ &lt;env: namespace:base&gt;
## [[3]] $ &lt;env: global&gt;</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">env_parents</span>(<span class="fu">fn_env</span>(rlang<span class="sc">::</span>fn_env))</span></code></pre></div>
<pre><code>## [[1]] $ &lt;env: imports:rlang&gt;
## [[2]] $ &lt;env: namespace:base&gt;
## [[3]] $ &lt;env: global&gt;</code></pre>
<p><img src="04_figs_env/namespace-env.png" alt="ancestors of namespace environment" width="40%"/></p></li>
<li><p>Below, let the yellow object be the <code>sd()</code> function defined in the package <code>{stats}</code>. Then whenever another function in <code>{stats}</code> uses <code>sd()</code> or <code>var()</code> it finds them in the <code>namespace:stats</code> environment. Right now, the <code>package:stats</code> environment also points to that function, so when the user uses <code>sd()</code> they can use the version created by the <code>{stats}</code> authors. However, if we change the definition of <code>var()</code>, we only change the binding in the <code>package:stats</code> environment, not in the <code>namespace:stats</code> environment. This means that <code>{stats}</code> functions will work even if we change the binding. In particular, <code>sd()</code>, which uses <code>var()</code>, will still work.</p>
<p><img src="04_figs_env/namespace.png" alt="namespace and package" width="40%"/></p></li>
</ul>
</div>
<div id="execution-environments" class="section level2">
<h2>Execution Environments</h2>
<ul>
<li><p>Each time a function is called, a new environment is created to host execution. This is called the <strong>execution environment</strong>.</p></li>
<li><p>This is why <code>a</code> is not saved between calls:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">env_has</span>(<span class="fu">current_env</span>(), <span class="st">&quot;a&quot;</span>)) {</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> a <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(a)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="fu">fn</span>()</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fn</span>()</span></code></pre></div>
<pre><code>## [1] 1</code></pre></li>
<li><p>The execution environment is always the child of the function environment.</p></li>
<li><p>Consider this function</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1.</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># 2.</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">+</span> a</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">h</span>(<span class="dv">1</span>) <span class="co"># 3.</span></span></code></pre></div></li>
<li><p>The yellow object is the <code>h()</code> function. The name <code>h</code> is in the global environment (bottom right). The execution environment is the top left. <code>x</code> binds to 1. Then <code>a</code> is defined, it binds to <code>2</code>. When the function completes, it returns <code>3</code> and so <code>y</code> binds to <code>3</code> in the global environment. The execution environment is garbage collected.</p>
<p><img src="04_figs_env/execution.png" alt="execution environment" width="40%"/></p></li>
<li><p>It is possible to explicitly return the execution environment so that it is not garbage collected. But this is rarely done.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>h2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> x <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  rlang<span class="sc">::</span><span class="fu">current_env</span>()</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">h2</span>(<span class="at">x =</span> <span class="dv">10</span>)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_print</span>(e)</span></code></pre></div>
<pre><code>## &lt;environment: 0x5620fe0b73d8&gt;
## Parent: &lt;environment: global&gt;
## Bindings:
## • a: &lt;dbl&gt;
## • x: &lt;dbl&gt;</code></pre></li>
<li><p>More frequently, the execution environment is maintained because it is a function environment of a returned function.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>plus <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(y) x <span class="sc">+</span> y</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>plus_one <span class="ot">&lt;-</span> <span class="fu">plus</span>(<span class="dv">1</span>)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>plus_one</span></code></pre></div>
<pre><code>## function(y) x + y
## &lt;environment: 0x5620fef39740&gt;</code></pre>
<p><img src="04_figs_env/closure.png" alt="execution environment is function environment" width="40%"/></p></li>
<li><p>Above figure: the global environment is the bottom box. The execution environment is the top box. The <code>plus()</code> function is the right yellow object. Its function environment and binding environment is the global environment. When <code>plus()</code> is called with <code>x = 1</code>, it creates the execution environment where <code>x</code> is bound to <code>1</code>. When <code>plus_one()</code> is defined, its function environment is the execution environment (since that is where it was created), but its binding environment is the global environment (where the name is bound). Note that the parent environment of the <code>plus()</code>’s execution environment is the global environment.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">fn_env</span>(plus_one)</span></code></pre></div>
<pre><code>## &lt;environment: 0x5620fef39740&gt;</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">env_parent</span>(rlang<span class="sc">::</span><span class="fu">fn_env</span>(plus_one))</span></code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre></li>
<li><p>When we call <code>plus_one()</code>, its execution environment will have the execution environment of <code>plus()</code> as its parent.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plus_one</span>(<span class="dv">2</span>)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<p><img src="04_figs_env/closure-call.png" alt="execution environment of plus_one()" width="40%"/></p></li>
<li><p>When we call <code>plus_one()</code> with <code>y</code> bound to 2 (execution environment top left), when it tries to find <code>x</code> it first searches in</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">fn_env</span>(plus_one)</span></code></pre></div>
<pre><code>## &lt;environment: 0x5620fef39740&gt;</code></pre>
<p>(execution environment top right) before going to the global environment (bottom).</p></li>
<li><p><strong>Exercise</strong> (Advanced R): Draw a diagram that shows the function environments of this function, along with all bindings for the given execution.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x1) {</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x2) {</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    f3 <span class="ot">&lt;-</span> <span class="cf">function</span>(x3) {</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>      x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f3</span>(<span class="dv">3</span>)</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">f2</span>(<span class="dv">2</span>)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="fu">f1</span>(<span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 6</code></pre></li>
</ul>
</div>
<div id="caller-environment" class="section level2">
<h2>Caller Environment</h2>
<ul>
<li><p>Recall, the <strong>function environment</strong> is the environment in which the function was created.</p></li>
<li><p>The <strong>caller environment</strong> is the environment in which the function was called (aka “used”)</p></li>
<li><p>You can get this environment inside a function via <code>rlang::caller_env()</code>.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>fn1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  fn2 <span class="ot">&lt;-</span> <span class="cf">function</span>(y) {</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    rlang<span class="sc">::</span><span class="fu">caller_env</span>()</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  e0 <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">current_env</span>() <span class="do">## The execution environment of fn1()</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  e1 <span class="ot">&lt;-</span> <span class="fu">fn2</span>() <span class="do">## The caller environment of fn2()</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  e2 <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">caller_env</span>() <span class="do">## The caller environment of fn1()</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(e0, e1, e2))</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="fu">fn1</span>()</span></code></pre></div>
<pre><code>## [[1]]
## &lt;environment: 0x5620fd497fe0&gt;
## 
## [[2]]
## &lt;environment: 0x5620fd497fe0&gt;
## 
## [[3]]
## &lt;environment: R_GlobalEnv&gt;</code></pre></li>
</ul>
</div>
</div>
<div id="applications" class="section level1">
<h1>Applications</h1>
<div id="numeric-derivatives" class="section level2">
<h2>Numeric Derivatives</h2>
<ul>
<li><p><code>stats::numericDeriv()</code> numerically evaluates the gradient of an expression at some value. It assumes that the evaluation occurs within some environment you provide.</p></li>
<li><p>Let’s calculate the gradient of <span class="math inline">\(x^y\)</span> evaluated at <span class="math inline">\(x = 3\)</span>.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>myenv <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">env</span>(<span class="at">x =</span> <span class="dv">3</span>, <span class="at">y =</span> <span class="dv">2</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">numericDeriv</span>(<span class="at">expr =</span> rlang<span class="sc">::</span><span class="fu">expr</span>(x <span class="sc">^</span> y), <span class="at">theta =</span> <span class="st">&quot;x&quot;</span>, <span class="at">rho =</span> myenv)</span></code></pre></div>
<pre><code>## [1] 9
## attr(,&quot;gradient&quot;)
##      [,1]
## [1,]    6</code></pre></li>
<li><p>From calculus, we know that the derivative of <span class="math inline">\(x^2\)</span> is <span class="math inline">\(2x\)</span>, and so the gradient evaluated at <span class="math inline">\(x = 3\)</span> should be <span class="math inline">\(2\times 3 = 6\)</span>.</p></li>
<li><p><code>rlang::expr()</code> is discussed in Chapter 19. Basically, it captures an expression without evaluating it. This is called “quoting”. We can then evaluate that expression with <code>eval()</code>.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">expr</span>(x<span class="sc">^</span><span class="dv">2</span>) </span></code></pre></div>
<pre><code>## x^2</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">expr</span>(x<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span> <span class="fu">eval</span>(<span class="at">envir =</span> myenv)</span></code></pre></div>
<pre><code>## [1] 9</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">expr</span>(<span class="fu">sum</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)))</span></code></pre></div>
<pre><code>## sum(c(1, 2, 3))</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>rlang<span class="sc">::</span><span class="fu">expr</span>(<span class="fu">sum</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))) <span class="sc">|&gt;</span> <span class="fu">eval</span>(<span class="at">envir =</span> rlang<span class="sc">::</span><span class="fu">global_env</span>())</span></code></pre></div>
<pre><code>## [1] 6</code></pre></li>
</ul>
</div>
<div id="managing-state" class="section level2">
<h2>Managing State</h2>
<ul>
<li><p>An R package cannot alter the global environment.</p></li>
<li><p>Objects in packages are locked, so cannot be changed.</p></li>
<li><p>Say you want to keep track of whether or not a function was run (e.g. to write a message on first use). I have done this to (i) say that a function is defunct or (ii) list out special licenses that cover a method.</p></li>
<li><p>One way you could keep track of this is to use super assign in a function that will change the value of a logical in the package environment.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>ran_fun <span class="ot">&lt;-</span> <span class="cn">FALSE</span> <span class="do">## Global variable</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>fun <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>ran_fun) {</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Here is a message&quot;</span>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    ran_fun <span class="ot">&lt;&lt;-</span> <span class="cn">FALSE</span> <span class="do">## this alters package environment</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="fu">fun</span>()</span></code></pre></div>
<pre><code>## Here is a message</code></pre>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fun</span>()</span></code></pre></div>
<pre><code>## Here is a message</code></pre></li>
<li><p>What I think is better is having an environment specific to messages, that way you have to worry less about global variables.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>menv <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">env</span>(<span class="at">ran_fun =</span> <span class="cn">FALSE</span>)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>fun <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>menv<span class="sc">$</span>ran_fun) {</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Here is a message&quot;</span>)</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    menv<span class="sc">$</span>ran_fun <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a><span class="fu">fun</span>()</span></code></pre></div>
<pre><code>## Here is a message</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fun</span>()</span></code></pre></div></li>
<li><p>This functionality is very popular, so <code>{rlang}</code> has a function dedicated to it.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>fun <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  rlang<span class="sc">::</span><span class="fu">warn</span>(<span class="st">&quot;Here is a message&quot;</span>, <span class="at">.frequency =</span> <span class="st">&quot;once&quot;</span>, <span class="at">.frequency_id =</span> <span class="st">&quot;ran_fun&quot;</span>)</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="fu">fun</span>()</span></code></pre></div>
<pre><code>## Warning: Here is a message
## This warning is displayed once per session.</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fun</span>()</span></code></pre></div></li>
<li><p><strong>Exercise</strong>: Use environments to keep a tally for how many times a function called <code>foo()</code> is run. Create another function called <code>foo_count()</code> that returns that number. E.g.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foo_count</span>()</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foo</span>()</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foo</span>()</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="fu">foo</span>()</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="fu">foo_count</span>()</span></code></pre></div>
<pre><code>## [1] 3</code></pre></li>
</ul>
</div>
</div>
<div id="r6-objects" class="section level1">
<h1>R6 Objects</h1>
<ul>
<li>We will not cover R6 objects, but they use environments to do modify-by-reference instead of copy-on-modify semantics. This makes them fast.</li>
</ul>
</div>
<div id="hashing" class="section level1">
<h1>Hashing</h1>
<ul>
<li><p>Hashing is a quick way to select an object from a bunch of possible objects. You use a hash key to select a hash value.</p></li>
<li><p>Hashing in R was done through the <code>{hash}</code> package using environments.</p></li>
<li><p>Hashing is way quicker than using a list or a vector.</p></li>
<li><p>In the below example, using hashing is about 1000 times faster than using native R vectors.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hash)</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>words <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;https://data-science-master.github.io/lectures/data/words.txt&quot;</span>,</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">header =</span> <span class="cn">TRUE</span>, </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na.strings =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">hash</span>(<span class="at">keys =</span> words<span class="sc">$</span>word, <span class="at">values =</span> <span class="fu">seq_along</span>(words<span class="sc">$</span>word))</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">seq_along</span>(words<span class="sc">$</span>word)</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(l) <span class="ot">&lt;-</span> words<span class="sc">$</span>word</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>  h<span class="sc">$</span>MOTIVITIES,</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>  l[[<span class="st">&quot;MOTIVITIES&quot;</span>]],</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(expression<span class="sc">:</span>result) <span class="sc">|&gt;</span></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">mem_alloc</th>
<th align="right">gc/sec</th>
<th align="right">n_itr</th>
<th align="right">n_gc</th>
<th align="right">total_time</th>
<th align="left">result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">h$MOTIVITIES</td>
<td align="right">1.39µs</td>
<td align="right">1.49µs</td>
<td align="right">465899.2</td>
<td align="right">0B</td>
<td align="right">0</td>
<td align="right">10000</td>
<td align="right">0</td>
<td align="right">21.5ms</td>
<td align="left">150000</td>
</tr>
<tr class="even">
<td align="left">l[[“MOTIVITIES”]]</td>
<td align="right">1.8ms</td>
<td align="right">1.93ms</td>
<td align="right">503.9</td>
<td align="right">0B</td>
<td align="right">0</td>
<td align="right">252</td>
<td align="right">0</td>
<td align="right">500.1ms</td>
<td align="left">150000</td>
</tr>
</tbody>
</table></li>
<li><p>Though, for this lookup to be worthwhile, you would need to be doing lookups millions of times a second.</p></li>
</ul>
</div>
<div id="new-functions" class="section level1">
<h1>New Functions</h1>
<ul>
<li><code>rlang::env()</code>: Create a new child environment.</li>
<li><code>rlang::env_print()</code>: Print an environment’s bindings.</li>
<li><code>rlang::env_names()</code>: Print names in an environment.</li>
<li><code>rlang::env_parent()</code>: Print the parent of an environment.</li>
<li><code>rlang::env_has()</code>: Test if an environment has a binding.</li>
<li><code>rlang::current_env()</code>: Access current environment.</li>
<li><code>rlang::env_bind()</code>: Add objects to an environment.</li>
<li><code>rlang::env_unbind()</code>: Remove objects from an environment.</li>
<li><code>rlang::global_env()</code>: Access global environment.</li>
<li><code>rlang::empty_env()</code>: Access the empty environment.</li>
<li><code>rlang::fn_env()</code>: Access the function environment.</li>
<li><code>rlang::caller_env()</code>: Access the caller environment.</li>
<li><code>rlang::search_envs()</code>: Show the search path.</li>
<li><code>identical()</code>: Check if two objects are exactly equal.</li>
</ul>
</div>

<!DOCTYPE html>
<hr>
<a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2132247"><img src="https://dcgerard.github.io/advancedr/nsf_logo.png" alt="National Science Foundation Logo" height="48px"/></a>
<a href="https://www.american.edu/cas/mathstat/"><img src="https://dcgerard.github.io/advancedr/au_logo.png" alt="American University Logo" height="48px"/></a>
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
