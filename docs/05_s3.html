<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="David Gerard" />

<meta name="date" content="2022-01-31" />

<title>S3 Objects</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link rel="shortcut icon" href="https://dcgerard.github.io/advancedr/au_logo_small.png" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Teaching Website for Advanced R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="data.html">Data</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/dcgerard/advancedr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">S3 Objects</h1>
<h4 class="author">David Gerard</h4>
<h4 class="date">2022-01-31</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#s3-basics">S3 Basics</a></li>
<li><a href="#classes">Classes</a>
<ul>
<li><a href="#constructor">Constructor</a></li>
<li><a href="#validator">Validator</a></li>
<li><a href="#helpers">Helpers</a></li>
</ul></li>
<li><a href="#generics">Generics</a></li>
<li><a href="#methods">Methods</a></li>
<li><a href="#the-design-of-an-s3-object">The Design of an S3 Object</a></li>
<li><a href="#inheritance">Inheritance</a>
<ul>
<li><a href="#next-method">Next Method</a></li>
</ul></li>
<li><a href="#example-simulation">Example: Simulation</a></li>
<li><a href="#documenting-s3">Documenting S3</a></li>
<li><a href="#type-predicates">Type Predicates</a></li>
<li><a href="#method-dispatch-technicalities">Method Dispatch Technicalities</a></li>
<li><a href="#vctrs-package"><code>{vctrs}</code> package</a></li>
<li><a href="#new-functions">New functions</a></li>
</ul>
</div>

<script>
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('left', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<div id="learning-objectives" class="section level1">
<h1>Learning Objectives</h1>
<ul>
<li>Chapter 13 of <a href="https://adv-r.hadley.nz/">Advanced R</a>
<ul>
<li>Most notes taken from Hadley’s book. Thank you so much.</li>
</ul></li>
</ul>
</div>
<div id="motivation" class="section level1">
<h1>Motivation</h1>
<ul>
<li><p>S3 is the most commonly used object-oriented programming (OOP) system in R.</p></li>
<li><p>Most of the common data types you are used to are S3.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data frames are S3</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(mtcars)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tibbles are S3</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>mt_tb <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>(mtcars)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(mt_tb)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lm objects are S3</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>lmout <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(lmout) </span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot2 plots are S3</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>pl <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(mtcars, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> wt, <span class="at">y =</span> mpg)) <span class="sc">+</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(pl)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tidymodels use S3</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>tdout <span class="ot">&lt;-</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  parsnip<span class="sc">::</span><span class="fu">linear_reg</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  parsnip<span class="sc">::</span><span class="fu">set_engine</span>(<span class="st">&quot;lm&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  parsnip<span class="sc">::</span><span class="fu">fit</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(tdout)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Factors are S3</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dates are S3</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">make_date</span>(<span class="at">year =</span> <span class="dv">1970</span>, <span class="at">month =</span> <span class="dv">1</span>, <span class="at">day =</span> <span class="dv">1</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre></li>
<li><p>If you are creating a package and you want OOP features, you should use S3 unless</p>
<ol style="list-style-type: decimal">
<li>You work in a large team, or you need to contribute to <a href="https://www.bioconductor.org/">Bioconductor</a> (use S4).</li>
<li>Modify-by-reference is important (use R6).</li>
</ol></li>
<li><p>This is since most R programmers are used to S3 (intuitively) and are not used to S4 or R6.</p></li>
</ul>
</div>
<div id="s3-basics" class="section level1">
<h1>S3 Basics</h1>
<ul>
<li><p>An S3 object is any variable with a <code>class</code> attribute. This is the full definition.</p></li>
<li><p>S3 objects may or may not have more attributes.</p></li>
<li><p>E.g. the <code>factor</code> class always has the <code>levels</code> attribute.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;C&quot;</span>, <span class="st">&quot;A&quot;</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(x)</span></code></pre></div>
<pre><code>## $levels
## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot;
## 
## $class
## [1] &quot;factor&quot;</code></pre></li>
<li><p>You can get the underlying base type by <code>unclass()</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unclass</span>(x)</span></code></pre></div>
<pre><code>## [1] 1 2 2 1 3 1
## attr(,&quot;levels&quot;)
## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot;</code></pre></li>
<li><p>Functions can be S3 objects as well as long as they have the <code>class</code> attribute.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sout <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(sout)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(sout)</span></code></pre></div>
<pre><code>## [1] &quot;stepfun&quot;  &quot;function&quot;</code></pre></li>
<li><p>S3 objects behave differently when passed to a <strong>generic</strong> function, a special type of function meant to provide different implementations based on the S3 class of the object.</p></li>
<li><p>Use <code>sloop::ftype()</code> to see if a function is generic. If it has the word “generic” is anywhere, it can be used as an S3 generic.</p></li>
<li><p>These are all S3 generics</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">ftype</span>(print)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;      &quot;generic&quot;</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">ftype</span>(summary)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;      &quot;generic&quot;</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">ftype</span>(plot)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;      &quot;generic&quot;</code></pre></li>
<li><p>But these are not:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">ftype</span>(lm)</span></code></pre></div>
<pre><code>## [1] &quot;function&quot;</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">ftype</span>(stop)</span></code></pre></div>
<pre><code>## [1] &quot;internal&quot;</code></pre></li>
<li><p>Generic functions behave differently depending on the class of the object.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mt_tb)</span></code></pre></div>
<pre><code>## # A tibble: 32 × 11
##      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
##  2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
##  3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
##  4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
##  5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
##  6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
##  7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
##  8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
##  9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
## 10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
## # … with 22 more rows</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lmout)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = mpg ~ wt, data = mtcars)
## 
## Coefficients:
## (Intercept)           wt  
##       37.29        -5.34</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pl)</span></code></pre></div>
<p><img src="05_s3_files/figure-html/unnamed-chunk-7-1.png" width="384" style="display: block; margin: auto;" /></p></li>
<li><p>This is <em>not</em> implemented by <code>if</code>-<code>else</code> statements. That would be inefficient because only the authors of <code>print()</code> (i.e. the R Core team) could add new functionality to new S3 objects. The idea of using generic functions allows us (new developers) to define new functionality to the same generics.</p></li>
<li><p>The implementation of a generic for a specific class is called a <strong>method</strong>.</p></li>
<li><p>The act of choosing a method from a generic is called <strong>method dispatch</strong>. Use <code>sloop::s3_dispatch()</code> to see this process.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(<span class="fu">print</span>(mt_tb))</span></code></pre></div>
<pre><code>##    print.tbl_df
## =&gt; print.tbl
##  * print.data.frame
##  * print.default</code></pre>
<ul>
<li>The <code>*</code> means the method exists but is not used.</li>
<li>The <code>=&gt;</code> means the method exists and is used.</li>
<li>So above, it did not find a method for <code>tbl_df</code>, so it moved on to <code>tbl</code> which does have a method and used it. So it did not go on to look for other methods (<code>data.frame</code> or the <code>default</code> method), even those classes both have methods.</li>
</ul></li>
<li><p>Below there is no <code>aperm()</code> method for matrices, integers, or numerics, so it used the default one, which is for arrays.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(<span class="fu">aperm</span>(mat, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>)))</span></code></pre></div>
<pre><code>##    aperm.matrix
##    aperm.integer
##    aperm.numeric
## =&gt; aperm.default</code></pre></li>
<li><p>You can access specific methods by <code>generic.class()</code>. E.g.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>stats<span class="sc">:::</span><span class="fu">print.lm</span>(lmout)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = mpg ~ wt, data = mtcars)
## 
## Coefficients:
## (Intercept)           wt  
##       37.29        -5.34</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aperm.default</span>(mat, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4]
## [1,]    1    2    3    4
## [2,]    5    6    7    8
## [3,]    9   10   11   12</code></pre></li>
<li><p>But these are often not exported and should generally <strong>not</strong> be accessed directly by the user, or other developers.</p></li>
<li><p>Lots of methods have <code>.</code> in the middle. But not all functions with <code>.</code> are methods. E.g. <code>read.csv()</code> and <code>t.test()</code> are not methods of generic functions. <code>read.csv()</code> is just a function with a dot in the name, and <code>t.test()</code> is just a generic function with a dot in the name. These functions were created before S3, which is why they are named poorly.</p></li>
<li><p>You can confirm that a function with a <code>.</code> in it is a method also with <code>sloop::is_s3_method()</code>.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">is_s3_method</span>(<span class="st">&quot;read.csv&quot;</span>)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">is_s3_method</span>(<span class="st">&quot;t.test&quot;</span>)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">is_s3_method</span>(<span class="st">&quot;print.default&quot;</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre></li>
<li><p>Because of the important role of <code>.</code>, you should never name variables or non method functions with a dot in them.</p></li>
<li><p>To find all of the methods of a generic, use <code>sloop::s3_methods_generic()</code>.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_methods_generic</span>(<span class="st">&quot;print&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 309 × 4
##    generic class       visible source             
##    &lt;chr&gt;   &lt;chr&gt;       &lt;lgl&gt;   &lt;chr&gt;              
##  1 print   acf         FALSE   registered S3method
##  2 print   AES         FALSE   registered S3method
##  3 print   all_vars    FALSE   registered S3method
##  4 print   anova       FALSE   registered S3method
##  5 print   ansi_string FALSE   registered S3method
##  6 print   ansi_style  FALSE   registered S3method
##  7 print   any_vars    FALSE   registered S3method
##  8 print   aov         FALSE   registered S3method
##  9 print   aovlist     FALSE   registered S3method
## 10 print   ar          FALSE   registered S3method
## # … with 299 more rows</code></pre></li>
<li><p>To find all methods for a class, use <code>sloop::s3_methods_class()</code>.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_methods_class</span>(<span class="st">&quot;data.frame&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 55 × 4
##    generic       class      visible source
##    &lt;chr&gt;         &lt;chr&gt;      &lt;lgl&gt;   &lt;chr&gt; 
##  1 [             data.frame TRUE    base  
##  2 [[            data.frame TRUE    base  
##  3 [[&lt;-          data.frame TRUE    base  
##  4 [&lt;-           data.frame TRUE    base  
##  5 $&lt;-           data.frame TRUE    base  
##  6 aggregate     data.frame TRUE    stats 
##  7 anyDuplicated data.frame TRUE    base  
##  8 anyNA         data.frame TRUE    base  
##  9 as.data.frame data.frame TRUE    base  
## 10 as.list       data.frame TRUE    base  
## # … with 45 more rows</code></pre></li>
<li><p><strong>Exercise</strong>: Explain the difference between each of the dots in <code>as.data.frame.data.frame()</code>. How would you typically use this method? Include in your discussion calls from the functions in the <code>{sloop}</code> package.</p></li>
<li><p><strong>Exercise</strong>: <code>mean()</code> is an S3 generic. What classes have a method for <code>mean()</code>. What is the difference between them?</p></li>
<li><p><strong>Exercise</strong> (Advanced R): What class of object does the following code return? What base type is it built on? What attributes does it use?</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">21</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(<span class="fu">rpois</span>(<span class="dv">100</span>, <span class="dv">10</span>))</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## Empirical CDF 
## Call: ecdf(rpois(100, 10))
##  x[1:14] =   4,   5,   6,  ...,  16,  17</code></pre></li>
<li><p><strong>Exercise</strong>: (Advanced R): What class of object does the following code return? What base type is it built on? What attributes does it use?</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">rpois</span>(<span class="dv">100</span>, <span class="dv">5</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## 
##  1  2  3  4  5  6  7  8  9 10 12 
##  1 11 17 13 11 22  8 11  4  1  1</code></pre></li>
</ul>
</div>
<div id="classes" class="section level1">
<h1>Classes</h1>
<ul>
<li><p>Again, an S3 object is <em>any</em> object with a class attribute, that you can create with:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and assign class in one step</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">structure</span>(<span class="fu">list</span>(), <span class="at">class =</span> <span class="st">&quot;my_class&quot;</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create, then set class</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x) <span class="ot">&lt;-</span> <span class="st">&quot;my_class&quot;</span></span></code></pre></div></li>
<li><p>You can get the class attribute by <code>class()</code> (as long as it is S3).</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;my_class&quot;</code></pre></li>
<li><p>Thous, it is a little safer to use <code>sloop::s3_class()</code>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_class</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;my_class&quot;</code></pre></li>
<li><p>You can test that an object is a certain class by <code>inherits()</code>.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(mtcars)</span></code></pre></div>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inherits</span>(mtcars, <span class="st">&quot;data.frame&quot;</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inherits</span>(mtcars, <span class="st">&quot;tibble&quot;</span>)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>mt_tb <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>(mtcars)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">inherits</span>(mt_tb, <span class="st">&quot;tbl_df&quot;</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inherits</span>(mt_tb, <span class="st">&quot;data.frame&quot;</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre></li>
<li><p>R has no checks that the structure of the class is as you intended. E.g., we can change the “data.frame” class to <code>"Date"</code> and bad things will happen (i.e. R will try to use the wrong generics on the data).</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(mt_tb) <span class="ot">&lt;-</span> <span class="st">&quot;Date&quot;</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>mt_tb</span></code></pre></div>
<pre><code>## Error in as.POSIXlt.Date(x): &#39;list&#39; object cannot be coerced to type &#39;double&#39;</code></pre></li>
<li><p>You have to be careful about enforcing the correct structure on your class. Best practice: For any S3 class you create, you should create 3 functions to help others build and validate your class:</p>
<ul>
<li>A <strong>constructor</strong> to make a new object with your class, for internal use only.</li>
<li>A <strong>validator</strong> that checks the structure of objects with your class.</li>
<li>A <strong>helper</strong> that allows users to create objects of your class.</li>
</ul></li>
</ul>
<div id="constructor" class="section level2">
<h2>Constructor</h2>
<ul>
<li><p>Your constructor should</p>
<ul>
<li>Be called <code>new_myclass()</code>, replacing “myclass” with the name of your class.</li>
<li>Have one argument for the base object (e.g. list, numeric vector, etc).</li>
<li>Check the type of the base object and types of each attribute.</li>
</ul></li>
<li><p>E.g. if we were to create our own class to recapitulate factors, called <code>factor2</code>, we would do</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>new_factor2 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">integer</span>(), <span class="at">levels =</span> <span class="fu">character</span>()) {</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.integer</span>(x))</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(levels))</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">structure</span>(x,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">levels =</span> levels,</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">class =</span> <span class="st">&quot;factor2&quot;</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>We can construct a factor as follows</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">new_factor2</span>(<span class="fu">c</span>(1L, 1L, 2L, 1L, 1L), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>))</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## [1] 1 1 2 1 1
## attr(,&quot;levels&quot;)
## [1] &quot;A&quot; &quot;B&quot;
## attr(,&quot;class&quot;)
## [1] &quot;factor2&quot;</code></pre></li>
</ul>
</div>
<div id="validator" class="section level2">
<h2>Validator</h2>
<ul>
<li><p>Making sure the structure of an object is what you would expect is expensive.</p></li>
<li><p>E.g., we need to make sure that the number of unique values in a factor is at most the number of levels in that factor.</p></li>
<li><p>Validator functions should:</p>
<ol style="list-style-type: decimal">
<li>Be named <code>validator_myclass()</code>.</li>
<li>Take as input just an object from your class.</li>
<li>Include a bunch of assertions testing the structure of the inputted object.</li>
<li>Return the original object.</li>
</ol></li>
<li><p>Let’s make a validator for <code>factor2</code>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>validate_factor2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">inherits</span>(x, <span class="st">&quot;factor2&quot;</span>))</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  values <span class="ot">&lt;-</span> <span class="fu">unclass</span>(x)</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  levels <span class="ot">&lt;-</span> <span class="fu">attr</span>(x, <span class="st">&quot;levels&quot;</span>)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(levels) <span class="sc">&lt;</span> <span class="fu">max</span>(values)) {</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;There must be at least as many `levels` as possible values in `x`&quot;</span>)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">validate_factor2</span>(x)</span></code></pre></div>
<pre><code>## [1] 1 1 2 1 1
## attr(,&quot;levels&quot;)
## [1] &quot;A&quot; &quot;B&quot;
## attr(,&quot;class&quot;)
## [1] &quot;factor2&quot;</code></pre></li>
</ul>
</div>
<div id="helpers" class="section level2">
<h2>Helpers</h2>
<ul>
<li><p>A helper function is a user-facing function that will</p>
<ol style="list-style-type: decimal">
<li>Be called <code>myclass()</code>.</li>
<li>Call first the constructor function, then the validator function.</li>
<li>Be user friendly.
<ul>
<li>Good defaults.</li>
<li>Accepts multiple types for the base object and coerces intelligently.</li>
</ul></li>
</ol></li>
<li><p>Let’s do this for <code>factor2</code>.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>factor2 <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">character</span>(), <span class="at">levels =</span> <span class="fu">unique</span>(x)) {</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  ind <span class="ot">&lt;-</span> <span class="fu">match</span>(x, levels)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">validate_factor2</span>(<span class="fu">new_factor2</span>(ind, levels)))</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="fu">factor2</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;A&quot;</span>))</span></code></pre></div>
<pre><code>## [1] 1 2 2 1
## attr(,&quot;levels&quot;)
## [1] &quot;A&quot; &quot;B&quot;
## attr(,&quot;class&quot;)
## [1] &quot;factor2&quot;</code></pre></li>
<li><p>Side note: <code>match()</code> is a useful function. It will provide the positions of the second argument that match the values in the second argument. E.g.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">match</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>))</span></code></pre></div>
<pre><code>## [1] 1 1 2 1 2</code></pre></li>
<li><p><strong>Exercise</strong> (Advanced R): Write a constructor for data.frame objects. What base type is a data frame built on? What attributes does it use? What are the restrictions placed on the individual elements? What about the names?</p></li>
</ul>
</div>
</div>
<div id="generics" class="section level1">
<h1>Generics</h1>
<ul>
<li><p>A generic function is just one that performs method dispatch. Method dispatch is implemented through <code>UseMethod()</code>, so it is really easy to create a new generic.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>mygeneric <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">&quot;mygeneric&quot;</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>No arguments are passed to <code>UseMethod()</code> except the name of the generic.</p></li>
<li><p>The <code>x</code> is a required argument that all methods must have. You can choose to have this be a different name, to have more required arguments, or to have no required arguments.</p></li>
<li><p>The <code>...</code> allows methods of your generic to include other variables than just <code>x</code>.</p></li>
<li><p>This is literally what most generic function definitions look like.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>mean</span></code></pre></div>
<pre><code>## function (x, ...) 
## UseMethod(&quot;mean&quot;)
## &lt;bytecode: 0x55702c91aeb0&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>print</span></code></pre></div>
<pre><code>## function (x, ...) 
## UseMethod(&quot;print&quot;)
## &lt;bytecode: 0x55702cf0ce58&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>plot</span></code></pre></div>
<pre><code>## function (x, y, ...) 
## UseMethod(&quot;plot&quot;)
## &lt;bytecode: 0x55702bd9c748&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>summary</span></code></pre></div>
<pre><code>## function (object, ...) 
## UseMethod(&quot;summary&quot;)
## &lt;bytecode: 0x55702ffb1948&gt;
## &lt;environment: namespace:base&gt;</code></pre></li>
<li><p>The key of a generic is its goals. Methods should generally align with the goals of the generic so that R users don’t get unexpected results. E.g. when you type <code>plot()</code> you shouldn’t output a mean (even though S3 makes this valid behavior).</p></li>
<li><p>How <code>UseMethod()</code> works: If an object has a class vector of <code>c("cl1", "cl2")</code> then <code>UseMethod()</code> will first search for a method for <code>cl1</code>, if it does not exist it will use the method for <code>cl2</code>, and if that does not exist it will use the default method (there is usually one).</p></li>
<li><p>E.g. all tibbles have class</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>mt_tb <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>(mtcars)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(mt_tb)</span></code></pre></div>
<pre><code>## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre></li>
<li><p>So any generic called with a tibble will first search for a <code>tbl_df</code> method, then a <code>tbl</code> method, then a <code>data.frame</code> method, then a default method (which would be for a list if applicable since tibbles are built on lists).</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(<span class="fu">print</span>(mt_tb))</span></code></pre></div>
<pre><code>##    print.tbl_df
## =&gt; print.tbl
##  * print.data.frame
##  * print.default</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(<span class="fu">str</span>(mt_tb))</span></code></pre></div>
<pre><code>## =&gt; str.tbl_df
##    str.tbl
##  * str.data.frame
##  * str.default</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(<span class="fu">summary</span>(mt_tb))</span></code></pre></div>
<pre><code>##    summary.tbl_df
##    summary.tbl
## =&gt; summary.data.frame
##  * summary.default</code></pre>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(<span class="fu">mean</span>(mt_tb))</span></code></pre></div>
<pre><code>##    mean.tbl_df
##    mean.tbl
##    mean.data.frame
## =&gt; mean.default</code></pre></li>
<li><p>The “default” class is not a real class, but is there so that there is always a fall back.</p></li>
</ul>
</div>
<div id="methods" class="section level1">
<h1>Methods</h1>
<ul>
<li><p>To create a method</p>
<ol style="list-style-type: decimal">
<li>Create a function definition for <code>generic.method()</code>.</li>
<li>Make sure you use the same arguments as the generic (but you can usually include more aguements if there is <code>...</code> in the generic).</li>
</ol></li>
<li><p>E.g., let’s create plot and print methods for our <code>factor2</code> class.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>print.factor2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">attr</span>(x, <span class="st">&quot;levels&quot;</span>)[x])</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(x))</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>plot.factor2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">y =</span> <span class="cn">NULL</span>) {</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  tabx <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">attr</span>(x, <span class="st">&quot;levels&quot;</span>)[x])</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">barplot</span>(<span class="fu">table</span>(<span class="fu">attr</span>(x, <span class="st">&quot;levels&quot;</span>)[x]))</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">invisible</span>(x))</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>Now, we get better printing for <code>factor2</code>’s</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">factor2</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>))</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;A&quot; &quot;B&quot; &quot;B&quot; &quot;A&quot; &quot;B&quot;</code></pre></li>
<li><p>Note: If you don’t know, whenever you just run something and have it print to the console, that is R implicitly running <code>print()</code>. So this looks better too:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;A&quot; &quot;B&quot; &quot;B&quot; &quot;A&quot; &quot;B&quot;</code></pre></li>
<li><p>Note: In a print method, you either call the <code>print()</code> method of another S3 object, or you call <code>cat()</code>, which does less under the hood than <code>print()</code>.</p></li>
<li><p>We can verify that method dispatch is working appropriately</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(<span class="fu">print</span>(x))</span></code></pre></div>
<pre><code>## =&gt; print.factor2
##  * print.default</code></pre></li>
<li><p>Plotting looks better too</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x)</span></code></pre></div>
<p><img src="05_s3_files/figure-html/unnamed-chunk-45-1.png" width="384" style="display: block; margin: auto;" /></p></li>
<li><p>You should only build methods for classes you own, or generics you own. It is considered bad manners to define a method for a class you do not own unless you own the generics.</p></li>
<li><p>E.g. if you define a new print method for <code>tbl_df</code>, then include that in your package, that would be impolite to the tidyverse folks.</p></li>
<li><p>A method should have the same arguments as the generic. You can have more arguments if the generic has <code>...</code> in it. E.g. if you create <code>plot()</code>, then you must include <code>x</code> and <code>y</code>, but may include anything else.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">formals</span>(plot)</span></code></pre></div>
<pre><code>## $x
## 
## 
## $y
## 
## 
## $...</code></pre></li>
<li><p><strong>Exercise</strong> (Advanced R): What generics does the <code>table</code> class have methods for?</p></li>
<li><p><strong>Exercise</strong>: Create a new generic called <code>pop</code> that will remove the last element and return the shorted object. Make a default method for any vector. Then make methods for the <code>matrix</code> class that will remove the last column or row, depending on the user choice of an argument called <code>by</code>.</p></li>
</ul>
</div>
<div id="the-design-of-an-s3-object" class="section level1">
<h1>The Design of an S3 Object</h1>
<ul>
<li><p>There are three most common structures for an S3 object.</p></li>
<li><p>In decreasing order of most common usage by you:</p></li>
</ul>
<ol style="list-style-type: decimal">
<li><p>A list-like object, where the list represents one thing (e.g. model output, function, dataset, etc…).</p>
<ul>
<li>For example, the output of <code>lm()</code> is a list like object that represents one model fit.</li>
</ul>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>lmout <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(lmout)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(lmout)</span></code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre>
<ul>
<li>I use this format all of the time for the outputs of my model fits.</li>
</ul></li>
<li><p>A vector with new functionality. E.g. <code>factor</code>s and <code>Date</code>s. You combine, print, mathematically operate with these vectors in different ways.</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>))</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;integer&quot;</code></pre></li>
<li><p>Lists of equal length length vectors. E.g. <code>data.frame</code>s and <code>POSIXlt</code> objects.</p>
<ul>
<li><code>POSIXlt</code> objects are lists of years, days, minutes, seconds, etc… with the <code>i</code>th element of each vector contributing to indicating the same moment in time.</li>
</ul>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">as.POSIXlt</span>(<span class="fu">ISOdatetime</span>(<span class="dv">2020</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>))</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## [1] &quot;2020-01-01 00:00:01 EST&quot; &quot;2020-01-01 00:00:02 EST&quot;
## [3] &quot;2020-01-01 00:00:03 EST&quot;</code></pre>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre>
<ul>
<li><code>data.frame</code> objects are lists of vectors where each vector is a variable and the <code>i</code>th element of each vector represents the same observational unit.</li>
</ul>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(mtcars)</span></code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre></li>
</ol>
</div>
<div id="inheritance" class="section level1">
<h1>Inheritance</h1>
<ul>
<li><p><strong>Inheritance</strong> is shared behavior. You can make your new class inherit from another class so that if you did not create a method, then it will fall back on the parent method.</p></li>
<li><p>We call the child class the <strong>subclass</strong> and the parent class the <strong>superclass</strong>.</p></li>
<li><p>E.g. the <code>tbl_df</code> (sub)class inherits from the <code>data.frame</code> (super)class.</p></li>
<li><p>You can simply create a subclass by including a vector of in the <code>class</code> attribute.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>mt_tb <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>(mtcars)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(mt_tb)</span></code></pre></div>
<pre><code>## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre></li>
<li><p>You should make sure your subclass is of the same base type as the superclass you are inheriting from. E.g. make sure anything you build off of <code>data.frame</code>s also has a list base type.</p></li>
<li><p>You should make sure that you have at least all of the same attributes as the superclass you are inheriting from. E.g. <code>data.frame</code>s can have <code>names</code> and <code>row.names</code>, and so any subclass should also have those attributes.</p></li>
</ul>
<div id="next-method" class="section level2">
<h2>Next Method</h2>
<ul>
<li><p><code>NextMethod()</code> allows you define methods for your class that use the functionality of classes that you inherit from.</p></li>
<li><p>E.g. recall that most attributes are lost with <code>[</code>.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">factor2</span>(<span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>))</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] 1</code></pre></li>
<li><p>This is because R is using the integer version for <code>[</code> and so we lose the class.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(x[<span class="dv">1</span>])</span></code></pre></div>
<pre><code>##    [.factor2
##    [.default
## =&gt; [ (internal)</code></pre></li>
<li><p>We cannot use <code>[</code> inside a definition for a method because we haven’t defined it yet.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="do">## won&#39;t work</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">[.factor2</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x, i) {</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x[i]) <span class="co"># but we haven&#39;t defined `[` yet</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>] <span class="do">## infinite recursion</span></span></code></pre></div></li>
<li><p>You can define your method to use the next method by <code>NextMethod()</code>. <code>NextMethod()</code> will take the arguments inside your function definition and run them through the next method in the inheritance list. So it returns an unclassed object, that you can then pass to your constructor function.</p></li>
<li><p>Make sure you also include the attributes in your constructor.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">[.factor2</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x, i) {</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">new_factor2</span>(<span class="fu">NextMethod</span>(), <span class="at">levels =</span> <span class="fu">attr</span>(x, <span class="st">&quot;levels&quot;</span>))</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_dispatch</span>(x[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span></code></pre></div>
<pre><code>## =&gt; [.factor2
##    [.default
## -&gt; [ (internal)</code></pre>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;A&quot; &quot;B&quot;</code></pre></li>
<li><p>If we did not pass <code>NextMethod()</code> to our constructor, it would just run the integer subsetting:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">[.factor2</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x, i) {</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NextMethod</span>()</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre><code>## [1] 1 1 2</code></pre></li>
</ul>
</div>
</div>
<div id="example-simulation" class="section level1">
<h1>Example: Simulation</h1>
<ul>
<li><p>Let’s work again on an a simulation function for linear regression. We started this in the <a href="./03_testing.html">Assertions and Unit Tests</a> lecture.</p></li>
<li><p>The basic function we had was as follows:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>simreg <span class="ot">&lt;-</span> <span class="cf">function</span>(x, beta0, beta1, sigma) {</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="at">n =</span> n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma)</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> x <span class="sc">+</span> eps</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(y)</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>Let’s create a basic list-like class so that we can define custom print, plot, and summary methods.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>new_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, beta0, beta1, sigma) {</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.double</span>(x),</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.double</span>(y),</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.double</span>(beta0),</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.double</span>(beta1),</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.double</span>(sigma),</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>            sigma <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">structure</span>(<span class="fu">list</span>(<span class="at">x =</span> x,</span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> y,</span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">beta0 =</span> beta0,</span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">beta1 =</span> beta1,</span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sigma =</span> sigma),</span>
<span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">class =</span> <span class="st">&quot;sim&quot;</span>)</span>
<span id="cb145-16"><a href="#cb145-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb145-17"><a href="#cb145-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>We can create a validator function to check that the specific structure is preserved</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>validate_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.list</span>(dat))</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.double</span>(dat<span class="sc">$</span>x),</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.double</span>(dat<span class="sc">$</span>y),</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.double</span>(dat<span class="sc">$</span>beta0),</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.double</span>(dat<span class="sc">$</span>beta1),</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">is.double</span>(dat<span class="sc">$</span>sigma))</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(dat<span class="sc">$</span>x) <span class="sc">==</span> <span class="fu">length</span>(dat<span class="sc">$</span>y), dat<span class="sc">$</span>sigma <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dat)</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>Let’s re-write our function to return this S3 class.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>simreg <span class="ot">&lt;-</span> <span class="cf">function</span>(x, beta0, beta1, sigma) {</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">rnorm</span>(<span class="at">n =</span> n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma)</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> x <span class="sc">+</span> eps</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">new_sim</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">beta0 =</span> beta0, <span class="at">beta1 =</span> beta1, <span class="at">sigma =</span> sigma))</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>This will allow us to make new a plot method</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>plot.sim <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">y =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">qplot</span>(<span class="at">x =</span> x<span class="sc">$</span>x, <span class="at">y =</span> x<span class="sc">$</span>y) <span class="sc">+</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">slope =</span> x<span class="sc">$</span>beta1, </span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">intercept =</span> x<span class="sc">$</span>beta0, </span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lty =</span> <span class="dv">2</span>, </span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">col =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;x&quot;</span>) <span class="sc">+</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;y&quot;</span>)</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>We can also make a new summary method</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>summary.sim <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  lmout <span class="ot">&lt;-</span> <span class="fu">lm</span>(object<span class="sc">$</span>y <span class="sc">~</span> object<span class="sc">$</span>x)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  beta0_ols <span class="ot">&lt;-</span> <span class="fu">coef</span>(lmout)[[<span class="dv">1</span>]]</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  beta1_ols <span class="ot">&lt;-</span> <span class="fu">coef</span>(lmout)[[<span class="dv">2</span>]]</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>  sigma_ols <span class="ot">&lt;-</span> <span class="fu">sigma</span>(lmout)</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">parameter =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta1&quot;</span>, <span class="st">&quot;sigma&quot;</span>),</span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">truth =</span> <span class="fu">c</span>(object<span class="sc">$</span>beta0, object<span class="sc">$</span>beta1, object<span class="sc">$</span>sigma),</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">ols =</span> <span class="fu">c</span>(beta0_ols, beta1_ols, sigma_ols))</span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>Let’s try all of this out</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">simreg</span>(<span class="at">x =</span> <span class="fu">runif</span>(<span class="dv">100</span>), <span class="at">beta0 =</span> <span class="dv">1</span>, <span class="at">beta1 =</span> <span class="dv">2</span>, <span class="at">sigma =</span> <span class="fl">0.25</span>)</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dat)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<p><img src="05_s3_files/figure-html/unnamed-chunk-66-1.png" width="384" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dat)</span></code></pre></div>
<pre><code>##   parameter truth    ols
## 1     beta0  1.00 0.9333
## 2     beta1  2.00 2.1661
## 3     sigma  0.25 0.2534</code></pre></li>
</ul>
</div>
<div id="documenting-s3" class="section level1">
<h1>Documenting S3</h1>
<ul>
<li><p>Generics, methods, constructors, validators, and helpers are all just regular functions, so you can document them as you would regular functions.</p></li>
<li><p>It is sometimes nice to have the same help file for the default method and the generic. You can do that via the <code>@describeIn</code> <code>{roxygen}</code> tag.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; Generic Function for generic.</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x An R object. </span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>generic <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @describeIn generic Default Method</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y is some default option</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; </span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>generic.default <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">y =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>See an example usage of this for the <code>mean()</code> and <code>summary()</code> documentation.</p></li>
<li><p><strong>Exercise</strong>: Document your <code>pop()</code> generic and the methods you made for <code>pop()</code>.</p></li>
</ul>
</div>
<div id="type-predicates" class="section level1">
<h1>Type Predicates</h1>
<ul>
<li><p>Whenever you make a new S3 class, you should always provide a type predict to test if an object is a certaint type.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>is_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">inherits</span>(x, <span class="st">&quot;sim&quot;</span>))</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">simreg</span>(<span class="at">x =</span> <span class="fu">runif</span>(<span class="dv">100</span>), <span class="at">beta0 =</span> <span class="dv">1</span>, <span class="at">beta1 =</span> <span class="dv">2</span>, <span class="at">sigma =</span> <span class="fl">0.25</span>)</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="fu">is_sim</span>(dat)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is_sim</span>(mtcars)  </span></code></pre></div>
<pre><code>## [1] FALSE</code></pre></li>
</ul>
</div>
<div id="method-dispatch-technicalities" class="section level1">
<h1>Method Dispatch Technicalities</h1>
<ul>
<li><p>Every variable in R has some <strong>implicit class</strong> even if it does not have a <code>class</code> attribute.</p></li>
<li><p>This <strong>implicit class</strong> is used to define methods for these objects, and to control method dispatch when you use a base type on a generic.</p></li>
<li><p><code>sloop::s3_class()</code> will return the implicit or explicit class of all objects.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(x) <span class="do">## not an S3 object</span></span></code></pre></div>
<pre><code>## [1] &quot;base&quot;</code></pre>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_class</span>(x) <span class="do">## implicit S3 class</span></span></code></pre></div>
<pre><code>## [1] &quot;double&quot;  &quot;numeric&quot;</code></pre>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">otype</span>(x) <span class="do">## not an S3 object</span></span></code></pre></div>
<pre><code>## [1] &quot;base&quot;</code></pre>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>sloop<span class="sc">::</span><span class="fu">s3_class</span>(x)</span></code></pre></div>
<pre><code>## [1] &quot;matrix&quot;  &quot;integer&quot; &quot;numeric&quot;</code></pre></li>
<li><p>So to create new matrix methods, you can do</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>generic.matrix <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>even though <code>matrix</code> is not an S3 class.</p></li>
<li><p>The following functions are called “group generics” <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>^</code>, <code>%%</code>, <code>%/%</code>, <code>&amp;</code>, <code>|</code>, <code>!</code>, <code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, and <code>&gt;</code>.</p></li>
<li><p>You can define methods for these group generics, but undergo what’s called double dispatch, choosing a method based on both arguments. This is what allows you to add integers and dates together. We will talk about how to do this correctly in the next lecture.</p></li>
</ul>
</div>
<div id="vctrs-package" class="section level1">
<h1><code>{vctrs}</code> package</h1>
<ul>
<li><p>By far, the most common use for S3 objects are list-like objects to add <code>plot()</code>/<code>summary()</code>/<code>print()</code> methods for folks who use your package.</p></li>
<li><p>But what if you want to create vector-like objects (e.g. <code>Dates</code> and <code>factors</code>)? Hadley provides a lot of nice examples:</p>
<ul>
<li>Percent: a double vector that prints as a percentage.</li>
<li>Decimal: a double vector that always prints with a fixed number of decimal places.</li>
<li>Cached sum: a double vector that caches the total sum in an attribute.</li>
<li>Rational: a pair of integer vectors that defines a rational number like 2 / 3.</li>
<li>Polynomial: a list of integer vectors that define polynomials like 1 + x - x^3.</li>
<li>Meter: a numeric vector with meter units.</li>
<li>Period and frequency: a pair of classes represent a period, or it’s inverse, frequency.</li>
</ul></li>
<li><p>It’s a lot of bookkeeping to do this properly. The <code>{vctrs}</code> package makes it a lot easier.</p></li>
<li><p>Read the <code>{vctrs}</code> vignette for more: <a href="https://vctrs.r-lib.org/articles/s3-vector.html" class="uri">https://vctrs.r-lib.org/articles/s3-vector.html</a></p></li>
<li><p>The simplest class, for percents, just changes the print method for doubles, but it is still a lot of work to get it to work:</p></li>
<li><p><code>percent</code> constructor</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>new_percent <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>()) {</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.double</span>(x))</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(vctrs<span class="sc">::</span><span class="fu">new_vctr</span>(x, <span class="at">class =</span> <span class="st">&quot;percent&quot;</span>))</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p><code>percent</code> helper</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>percent <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>()) {</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> vctrs<span class="sc">::</span><span class="fu">vec_cast</span>(x, <span class="fu">double</span>()) <span class="co"># tries to convert to double</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">new_percent</span>(x))</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p><code>format()</code> method for <code>percent</code> (in <code>{vctrs}</code> this also controls the <code>print()</code> method)</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>format.percent <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">formatC</span>(vctrs<span class="sc">::</span><span class="fu">vec_data</span>(x) <span class="sc">*</span> <span class="dv">100</span>, <span class="at">digits =</span> <span class="dv">1</span>, <span class="at">format =</span> <span class="st">&quot;f&quot;</span>)</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>  ret[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>  ret[<span class="sc">!</span><span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(ret[<span class="sc">!</span><span class="fu">is.na</span>(x)], <span class="st">&quot;%&quot;</span>)</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ret)</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>Allow <code>percent</code> objects to be combined with doubles (using <code>vec_c()</code>)</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># type for combination should be percent</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>vec_ptype2.percent.double <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, ...) {</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">percent</span>()</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>vec_ptype2.double.percent <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, ...) {</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">percent</span>()</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a><span class="co"># How to cast (change type) based on operation</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>vec_cast.percent.double <span class="ot">&lt;-</span> <span class="cf">function</span>(x, to, ...) <span class="fu">percent</span>(x) </span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>vec_cast.double.percent <span class="ot">&lt;-</span> <span class="cf">function</span>(x, to, ...) vctrs<span class="sc">::</span><span class="fu">vec_data</span>(x) </span></code></pre></div>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">percent</span>(<span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>))</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>vctrs<span class="sc">::</span><span class="fu">vec_c</span>(x, <span class="fl">0.1</span>)</span></code></pre></div>
<pre><code>## &lt;percent[3]&gt;
## [1] 10.0% 20.0% 10.0%</code></pre></li>
<li><p>Allow percents to be added/subtracted</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>vec_arith.percent <span class="ot">&lt;-</span> <span class="cf">function</span>(op, x, y, ...) {</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">&quot;vec_arith.percent&quot;</span>, y)</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>vec_arith.percent.default <span class="ot">&lt;-</span> <span class="cf">function</span>(op, x, y, ...) {</span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop_incompatible_op</span>(op, x, y)</span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>vec_arith.percent.percent <span class="ot">&lt;-</span> <span class="cf">function</span>(op, x, y, ...) { <span class="co"># method when have two percents</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span>(</span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>    op,</span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;+&quot;</span> <span class="ot">=</span> , <span class="co"># go to next</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;-&quot;</span> <span class="ot">=</span> <span class="fu">new_percent</span>(vctrs<span class="sc">::</span><span class="fu">vec_arith_base</span>(op, x, y)), <span class="co"># do double ops, then convert</span></span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;/&quot;</span> <span class="ot">=</span> vctrs<span class="sc">::</span><span class="fu">vec_arith_base</span>(op, x, y), <span class="co"># units cancel</span></span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop_incompatible_op</span>(op, x, y) <span class="co"># * makes less sense</span></span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">percent</span>(<span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>))</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">percent</span>(<span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.7</span>))</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>x <span class="sc">+</span> y</span></code></pre></div>
<pre><code>## &lt;percent[2]&gt;
## [1] 60.0% 80.0%</code></pre>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>x <span class="sc">-</span> y</span></code></pre></div>
<pre><code>## &lt;percent[2]&gt;
## [1] -40.0% -60.0%</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>x <span class="sc">/</span> y</span></code></pre></div>
<pre><code>## [1] 0.2000 0.1429</code></pre></li>
<li><p>Most folks don’t need to create new vectors, so we won’t cover this package in more detail. But it is really cool what you can do with it.</p></li>
</ul>
</div>
<div id="new-functions" class="section level1">
<h1>New functions</h1>
<ul>
<li><code>class()</code>: Assign or get the class attribute.</li>
<li><code>unclass()</code>: Remove class attribute and obtain underlying base type.</li>
<li><code>inherits()</code>: Test if an object is an instance of a given class.</li>
<li><code>sloop::ftype()</code>: See if a function is a “regular/primitive/internal function, a internal/S3/S4 generic, or a S3/S4/RC method”.</li>
<li><code>sloop::s3_dispatch()</code>: View method dispatch.</li>
<li><code>sloop::s3_methods_generic()</code>: View all methods of a generic function.</li>
<li><code>sloop::s3_methods_class()</code>: View all methods implemented for a specific class.</li>
<li><code>sloop::s3_class()</code>: Returns implicit and explicit class.</li>
<li><code>sloop::is_s3_method()</code>: Predicate function for determining if a function is an S3 method.</li>
<li><code>UseMethod()</code>: Used in a generic to define it as a generic.</li>
<li><code>NextMethod()</code>: Apply the next method, in the method dispatch chain, of the called generic.</li>
</ul>
</div>

<!DOCTYPE html>
<hr>
<a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2132247"><img src="https://dcgerard.github.io/advancedr/nsf_logo.png" alt="National Science Foundation Logo" height="48px"/></a>
<a href="https://www.american.edu/cas/mathstat/"><img src="https://dcgerard.github.io/advancedr/au_logo.png" alt="American University Logo" height="48px"/></a>
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
