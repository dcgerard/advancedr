<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="David Gerard" />

<meta name="date" content="2022-02-25" />

<title>R Futures and Parallel Processing</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link rel="shortcut icon" href="https://dcgerard.github.io/advancedr/au_logo_small.png" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Teaching Website for Advanced R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="data.html">Data</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/dcgerard/advancedr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">R Futures and Parallel Processing</h1>
<h4 class="author">David Gerard</h4>
<h4 class="date">2022-02-25</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#learning-objectives">Learning Objectives</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#future-overview">Future Overview</a></li>
<li><a href="#evaluation-plans">Evaluation Plans</a></li>
<li><a href="#furrr"><code>{furrr}</code></a></li>
<li><a href="#foreach"><code>{foreach}</code></a></li>
<li><a href="#simulation-study-example">Simulation Study Example</a></li>
<li><a href="#bash-notes">Bash notes:</a></li>
<li><a href="#new-functions">New Functions</a></li>
</ul>
</div>

<script>
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('left', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<div id="learning-objectives" class="section level1">
<h1>Learning Objectives</h1>
<ul>
<li>Futures, batch jobs, parallel processing.</li>
<li><a href="https://future.futureverse.org/articles/future-1-overview.html">Comprehensive Overview of Futures</a></li>
<li><a href="https://cran.r-project.org/web/packages/doFuture/vignettes/doFuture.html"><code>{doFuture}</code> Vignette</a></li>
<li><a href="https://cran.r-project.org/web/packages/foreach/vignettes/foreach.html"><code>{foreach}</code> Vignette</a></li>
<li><a href="https://furrr.futureverse.org/"><code>{furrr}</code> Website</a></li>
</ul>
</div>
<div id="motivation" class="section level1">
<h1>Motivation</h1>
<ul>
<li><p><a href="https://en.wikipedia.org/wiki/Parallel_computing">Parallel computing</a> is where you run many processes at the same time.</p></li>
<li><p>E.g., suppose I run this code to calculate the mean of a sample of 10 uniformly distributed observations, and repeat this 1000 times.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>nsamp <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>nind <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>outvec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="at">length.out =</span> nsamp)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(nsamp)) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  outvec[[i]] <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">runif</span>(nind))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Each iteration does not depend on any other iteration, so we could potentially run each iteration independently and simultaneously.</p></li>
<li><p>This could potentially speed things up:</p>
<p><img src="09_figs/parallel.png" width="50%" style="display: block; margin: auto;" /></p></li>
<li><p>Parallel processing can be beneficial if all of the following are true:</p>
<ol style="list-style-type: decimal">
<li>You have independent iterations (though this can be relaxed in sophisticated and clever ways).</li>
<li>Each iteration takes awhile (not a millionth of a second).</li>
<li>You aren’t passing huge datasets around each iteration.</li>
</ol></li>
<li><p>Sometimes, if you have a quick for-loop, the overhead of parallelization actually can slow things down. This is why parts 2 and 3 are important.</p></li>
<li><p>E.g., we would never parallelize the for-loop example above.</p></li>
<li><p>We will talk about a relatively new approach to parallel processing in R through the use of “futures”.</p></li>
</ul>
</div>
<div id="future-overview" class="section level1">
<h1>Future Overview</h1>
<ul>
<li><p>A <a href="https://en.wikipedia.org/wiki/Futures_and_promises"><strong>future</strong></a> is a value that may be available at some point in the future. This value is the result of an expression (either evaluated or unevaluated).</p></li>
<li><p>The <a href="https://future.futureverse.org/"><code>{future}</code></a> package implements a nice future data structure built on top of environments.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span></code></pre></div></li>
<li><p>When you create a future, you create something that may eventually have a value.</p></li>
<li><p>When you use a future, you evaluate the expression, obtain that value, and use that value.</p></li>
<li><p>Futures can be evaluated sequentially or in parallel, on the same machine or on a distributed cluster of machines.</p></li>
<li><p>The idea of a future is that you can write the <strong>same R code</strong> for sequential single computer jobs, as well as for large parallel jobs on the supercomputer, and the R code will work in both scenarios. This is pretty awesome.</p></li>
<li><p>This is also great because different types of parallel processing sometimes require different types of code. Using a future means that you don’t need to worry about the parallel processing environment.</p></li>
<li><p>Example: Below, we do normal evaluation, binding <code>x</code> to 10. This is evaluated right away, and so <code>"Hello World"</code> is printed.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">&quot;Hello World</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>      <span class="dv">10</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>     }</span></code></pre></div>
<pre><code>## Hello World</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>x <span class="sc">+</span> <span class="dv">1</span></span></code></pre></div>
<pre><code>## [1] 11</code></pre>
<p>Below, we create a future that is not evaluated right away, so <code>"Hello World"</code> is not printed. It just can be evaluated at some point.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&lt;-%</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">&quot;Hello World</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="dv">10</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>       }</span></code></pre></div>
<p>When we use <code>x</code>, then the future is evaluated, the expression runs, and “Hello World” is printed.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>x <span class="sc">+</span> <span class="dv">1</span></span></code></pre></div>
<pre><code>## Hello World</code></pre>
<pre><code>## [1] 11</code></pre></li>
<li><p>Alternatively, we can explicitly create a future with <code>future::future()</code></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">future</span>({</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Hello World</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">10</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>and evaluate it with <code>future::value()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">value</span>(f) <span class="sc">+</span> <span class="dv">1</span></span></code></pre></div>
<pre><code>## Hello World</code></pre>
<pre><code>## [1] 11</code></pre></li>
<li><p>You can create futures using <code>%&lt;-%</code> or <code>future::future()</code>, like I did above. But it is more common to use a the <code>{future}</code> package as a backend to a more familiar API.</p>
<ul>
<li><a href="https://cran.r-project.org/package=furrr"><code>{furrr}</code></a>: Uses the <code>{purrr}</code> API.</li>
<li><a href="https://cran.r-project.org/web/packages/foreach/index.html"><code>{foreach}</code></a>: Uses a for-loop API.</li>
<li><a href="https://cran.r-project.org/package=future.apply"><code>{future.apply}</code></a>: Uses base R vectorization API (like <code>apply()</code>, <code>sapply()</code>, <code>vapply()</code>, etc)</li>
</ul></li>
</ul>
</div>
<div id="evaluation-plans" class="section level1">
<h1>Evaluation Plans</h1>
<ul>
<li><p>You use <code>future::plan()</code> to determine if a future will be evaluated sequentially or in parallel using a particular strategy.</p></li>
<li><p>You basically just run <code>future::plan()</code> once, and the <code>{future}</code> package will automatically run processes according to your plan.</p></li>
<li><p>I am going to demonstrate plans by using the <code>Sys.getpid()</code> function, which returns the process ID of the R session. So different ID’s means that the evaluation occurs on different processes.</p></li>
<li><p>Using this, the following with run <code>Sys.getpid()</code> three times:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">map_int</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="sc">~</span><span class="fu">Sys.getpid</span>())</span></code></pre></div>
<pre><code>## [1] 73247 73247 73247</code></pre></li>
<li><p>We will use <code>furrr::future_map_int()</code> instead to run these as futures.</p></li>
<li><p><code>plan("sequential")</code> is the default and basically just runs R like you normally would. So all evaluation occurs in the same R process/session.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;sequential&quot;</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>furrr<span class="sc">::</span><span class="fu">future_map_int</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="sc">~</span><span class="fu">Sys.getpid</span>())</span></code></pre></div>
<pre><code>## [1] 73247 73247 73247</code></pre></li>
<li><p>If your computer has multiprocessing or multithreading capabilities, then you can run your code in parallel.</p></li>
<li><p>See how many cores you have available by</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">availableCores</span>()</span></code></pre></div>
<pre><code>## system 
##      8</code></pre></li>
<li><p>Whatever number you get is the <strong>maximum</strong> that you should try. However, if you are on a super computer, then you typically want to use much fewer than that number, otherwise you will be using up too much resources and the admins will frown on that (always be nice to your admins). Always read the documentation your admins give you to determine your resource allowances.</p></li>
<li><p><code>plan("multisession", workers = n)</code>: Creates <code>n</code> new R sessions, and evaluates futures on these new R sessions. This allows for parallel computing.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multisession&quot;</span>, <span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>furrr<span class="sc">::</span><span class="fu">future_map_int</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="sc">~</span><span class="fu">Sys.getpid</span>())</span></code></pre></div>
<pre><code>## [1] 73319 73320 73321</code></pre></li>
<li><p><code>plan("multicore", workers = n)</code>: Creates <code>n</code> copies of your current R process (called “forking”), and evaluates futures on these new R processes. This allows for parallel computing.</p>
<ul>
<li>Not available on Windows machines.</li>
<li>Strongly discouraged while running RStudio.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multicore&quot;</span>, <span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>furrr<span class="sc">::</span><span class="fu">future_map_int</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="sc">~</span><span class="fu">Sys.getpid</span>())</span></code></pre></div>
<pre><code>## [1] 73451 73452 73453</code></pre></li>
<li><p>My understanding is that forking (using “multicore”) means that the processes share the same memory addresses for objects (these objects are read-only in the child processes). While creating new R sessions means that everything needs to be copied over to a new R session. So forking can be faster. But I guess forking can also be dangerous because it can cause the process to “lock” (stall) in some rare cases (for technical reasons). But my understanding is tenuous, so if you know better, let me know.</p></li>
<li><p>So you should typically use <code>plan("multisession", workers = n)</code> if you are doing parallelization on one computer.</p></li>
</ul>
</div>
<div id="furrr" class="section level1">
<h1><code>{furrr}</code></h1>
<ul>
<li><p>We used <code>{furrr}</code> for the examples above. If you know <code>{purrr}</code> then switching to parallel computing should be pretty easy.</p></li>
<li><p>Here are the steps:</p>
<ol style="list-style-type: decimal">
<li>Implement the code you want to parallelize using functional programming as you would with <code>{purrr}</code>. But use the <code>{furrr}</code> drop-in replacements.</li>
<li>Use the appropriate <code>plan()</code> call.</li>
<li>Run the code.</li>
</ol></li>
<li><p>Implemented functions:</p>
<ul>
<li><code>future_map()</code></li>
<li><code>future_map2()</code></li>
<li><code>future_pmap()</code></li>
<li><code>future_walk()</code></li>
<li><code>future_imap()</code></li>
<li><code>future_modify()</code></li>
</ul></li>
<li><p>You usually create a function that you want to call repeatedly</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Then you call <code>{furrr}</code> functions on it.</p></li>
<li><p>Let’s compare sequential and parallel processing times:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;sequential&quot;</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map_dbl</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, f)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.012   0.000   3.015</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multisession&quot;</span>, <span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> furrr<span class="sc">::</span><span class="fu">future_map_dbl</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, f)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.086   0.001   1.630</code></pre></li>
</ul>
</div>
<div id="foreach" class="section level1">
<h1><code>{foreach}</code></h1>
<ul>
<li><p><code>{foreach}</code> is a package that gives another API for doing a for-loop.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span></code></pre></div></li>
<li><p>The biggest difference is that in a <code>{foreach}</code> for-loop, you save the output to a final destination. In a regular for-loop, each iteration produces side effects.</p></li>
<li><p>The syntax for a <code>{foreach}</code> for-loop is:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">%do%</span> {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## code that returns some element each iteration.</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## These will be combined in some way and assigned to x</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>The <code>{foreach}</code> for-loop by default combines the outputs in a list.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%do%</span> {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(i)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 1.414
## 
## [[3]]
## [1] 1.732</code></pre></li>
<li><p>You can change how the outputs are combined by the <code>.combine</code> argument. Typically, you combine either using <code>c</code>, <code>rbind</code>, or <code>cbind</code>.</p></li>
<li><p>Using <code>c</code> returns a vector</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%do%</span> {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(i)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## [1] 1.000 1.414 1.732</code></pre></li>
<li><p>Using <code>rbind</code> will make each returned vector a row.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> rbind) <span class="sc">%do%</span> {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">sqrt =</span> <span class="fu">sqrt</span>(i), <span class="at">square =</span> i<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>##           sqrt square
## result.1 1.000      1
## result.2 1.414      4
## result.3 1.732      9</code></pre></li>
<li><p>To do parallel processing with <code>foreach()</code>:</p>
<ol style="list-style-type: decimal">
<li>Attach the <code>{doFuture}</code> package.</li>
<li>Run <code>doFuture::registerDoFuture()</code>.
<ul>
<li>This makes it so that <code>{foreach}</code> knows to use the parallelization backend from <code>{future}</code>.</li>
<li>It’s possible to use other backends. E.g., if you run <code>doParallel::registerDoParallel()</code> then <code>{foreach}</code> will use the <code>{parallel}</code> backend.</li>
</ul></li>
<li>Run <code>future::plan()</code></li>
<li>Replace <code>%do%</code> with <code>%dopar%</code>.</li>
</ol>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multisession&quot;</span>, <span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> {</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.getpid</span>()</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## [1] 73590 73589 73591</code></pre></li>
<li><p>If you are simulating anything inside a <code>{foreach}</code> for-loop (or using the random number generator in any way), then you need to use the <code>{doRNG}</code> package.</p>
<ol style="list-style-type: decimal">
<li>Attach the <code>{doRNG}</code> package.</li>
<li>Run <code>doFuture::registerDoFuture()</code></li>
<li>Run <code>doRNG::registerDoRNG()</code></li>
<li>Run <code>future::plan()</code></li>
<li>Replace <code>%do%</code> with <code>%dopar%</code>.</li>
</ol></li>
<li><p>Doing this makes reproducibility possible.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doRNG)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoRNG</span>()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multisession&quot;</span>, <span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> {</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>x <span class="sc">==</span> y</span></code></pre></div>
<pre><code>## [1] TRUE TRUE TRUE</code></pre></li>
<li><p>If you don’t do this, then reproducibility is impossible, even if you set the seed to the same value each time:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>doFuture<span class="sc">::</span><span class="fu">registerDoFuture</span>()</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multisession&quot;</span>, <span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> {</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> c) <span class="sc">%dopar%</span> {</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>## [1] 0.5632 0.2796 0.3843</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>y</span></code></pre></div>
<pre><code>## [1] 0.8335 0.1817 0.2702</code></pre></li>
</ul>
</div>
<div id="simulation-study-example" class="section level1">
<h1>Simulation Study Example</h1>
<ul>
<li><p>The <code>{HardyWeinberg}</code> package contains four tests for <a href="https://en.wikipedia.org/wiki/Hardy%E2%80%93Weinberg_principle">Hardy-Weinberg Equilibrium</a>, a <span class="math inline">\(\chi^2\)</span>-test, a likelihood ratio test, an exact test, and a permutation test.</p></li>
<li><p>The following will simulate genotype frequencies under different sample sizes <code>n</code>, allele frequencies <code>af</code> (between 0 and 1), and fixation indices <code>fx</code> (between 0 and 1, but typically less than 0.15). HWE is fulfilled when <code>fx = 0</code>.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param n Sample size</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param af Allele frequency</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param fx Fixation index. Null hypothesis of HWE is true if fx = 0.</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>hwesim <span class="ot">&lt;-</span> <span class="cf">function</span>(n, af, fx) {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  probvec <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    af <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> af <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> af) <span class="sc">*</span> fx,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span> <span class="sc">*</span> af <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> af) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> fx),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">-</span> af) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> af <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> af) <span class="sc">*</span> fx</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  retvec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rmultinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> n, <span class="at">prob =</span> probvec))</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(retvec) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;AA&quot;</span>, <span class="st">&quot;AB&quot;</span>, <span class="st">&quot;BB&quot;</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(retvec)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>We can then run the HWE tests from the package:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">hwesim</span>(<span class="at">n =</span> <span class="dv">100</span>, <span class="at">af =</span> <span class="fl">0.5</span>, <span class="at">fx =</span> <span class="fl">0.1</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>HardyWeinberg<span class="sc">::</span><span class="fu">HWChisq</span>(<span class="at">X =</span> x)</span></code></pre></div>
<pre><code>## Chi-square test with continuity correction for Hardy-Weinberg equilibrium (autosomal)
## Chi2 =  0.35 DF =  1 p-value =  0.5541 D =  -1.84 f =  0.07407</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>HardyWeinberg<span class="sc">::</span><span class="fu">HWLratio</span>(<span class="at">X =</span> x)</span></code></pre></div>
<pre><code>## Likelihood ratio test for Hardy-Weinberg equilibrium
## G2 = 0.5489 DF = 1 p-value = 0.4588</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>HardyWeinberg<span class="sc">::</span><span class="fu">HWExact</span>(<span class="at">X =</span> x)</span></code></pre></div>
<pre><code>## Haldane Exact test for Hardy-Weinberg equilibrium (autosomal)
## using SELOME p-value
## sample counts: nAA =  23 nAB =  46 nBB =  31 
## H0: HWE (D==0), H1: D &lt;&gt; 0 
## D =  -1.84 p-value =  0.5452</code></pre></li>
<li><p>If we want to explore the performance between these three methods (I’ll discuss the permutation approach soon), we would probably vary</p>
<ul>
<li><code>n</code> <span class="math inline">\(\in \{10, 100, 1000, 10000\}\)</span></li>
<li><code>af</code> <span class="math inline">\(\in \{0.01, 0.1, 0.25, 0.5\}\)</span></li>
<li><code>fx</code> <span class="math inline">\(\in \{0, 0.05, 0.1, 0.15\}\)</span></li>
</ul></li>
<li><p>This is <span class="math inline">\(3 * 4^2 = 48\)</span> unique combinations, and in each combination we would probably want to run 1000 replications. So that’s 48000 replications.</p></li>
<li><p>Let’s first create a data frame containing the possible parameter values:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>nrep <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>nvec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">1000</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>afvec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>fxvec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.15</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>paramdf <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">seed =</span> <span class="dv">1</span><span class="sc">:</span>nrep,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">n =</span> nvec,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">af =</span> afvec,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fx =</span> fxvec)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(paramdf)</span></code></pre></div>
<pre><code>## [1] 48000     4</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(paramdf)</span></code></pre></div>
<pre><code>##   seed  n   af fx
## 1    1 10 0.01  0
## 2    2 10 0.01  0
## 3    3 10 0.01  0
## 4    4 10 0.01  0
## 5    5 10 0.01  0
## 6    6 10 0.01  0</code></pre></li>
<li><p>If we were doing a for-loop, we would probably first populate the data frame with all of the output we want. Here, let’s say we want the <span class="math inline">\(p\)</span>-values for each test:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>paramdf<span class="sc">$</span>p_chisq <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>paramdf<span class="sc">$</span>p_lratio <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>paramdf<span class="sc">$</span>p_exact <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span></code></pre></div></li>
<li><p>We would then iterate through this data frame, populating the output</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>pb <span class="ot">&lt;-</span> progress<span class="sc">::</span>progress_bar<span class="sc">$</span><span class="fu">new</span>(<span class="at">total =</span> <span class="fu">nrow</span>(paramdf))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(paramdf))) {</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  pb<span class="sc">$</span><span class="fu">tick</span>()</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(paramdf<span class="sc">$</span>seed[[i]])</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> paramdf<span class="sc">$</span>n[[i]]</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  af <span class="ot">&lt;-</span> paramdf<span class="sc">$</span>af[[i]]</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  fx <span class="ot">&lt;-</span> paramdf<span class="sc">$</span>fx[[i]]</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">hwesim</span>(<span class="at">n =</span> n, <span class="at">af =</span> af, <span class="at">fx =</span> fx)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  paramdf<span class="sc">$</span>p_chisq[[i]]  <span class="ot">&lt;-</span> HardyWeinberg<span class="sc">::</span><span class="fu">HWChisq</span>(<span class="at">X =</span> x, <span class="at">verbose =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>pval</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  paramdf<span class="sc">$</span>p_lratio[[i]] <span class="ot">&lt;-</span> HardyWeinberg<span class="sc">::</span><span class="fu">HWLratio</span>(<span class="at">X =</span> x, <span class="at">verbose =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>pval</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  paramdf<span class="sc">$</span>p_exact[[i]]  <span class="ot">&lt;-</span> HardyWeinberg<span class="sc">::</span><span class="fu">HWExact</span>(<span class="at">X =</span> x, <span class="at">verbose =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>pval</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
<li><p>When I ran this on my laptop, it took about a minute, which isn’t that bad, so I wouldn’t bother parallelizing here.</p></li>
<li><p>But if I also wanted to compare <code>HardyWeinberg::HWPerm()</code>, this one function alone takes about 5 seconds by itself</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">hwesim</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">af =</span> <span class="fl">0.5</span>, <span class="at">fx =</span> <span class="fl">0.15</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  HardyWeinberg<span class="sc">::</span><span class="fu">HWPerm</span>(<span class="at">x =</span> x, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   5.523   0.001   5.523</code></pre>
<p>So if I had to include that in the simulation study, it could take up to <span class="math inline">\(5 \times 48000 / 60 / 60 = 66.7\)</span> hours, and I would totally parallelize in this scenario.</p></li>
<li><p>The code for parallelization looks like this:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>paramdf <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">seed =</span> <span class="dv">1</span><span class="sc">:</span>nrep,</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">n =</span> nvec,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">af =</span> afvec,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fx =</span> fxvec)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoRNG</span>()</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multisession&quot;</span>, <span class="at">workers =</span> <span class="fu">availableCores</span>())</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>pmat <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(paramdf)), <span class="at">.combine =</span> rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(paramdf<span class="sc">$</span>seed[[i]])</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> paramdf<span class="sc">$</span>n[[i]]</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  af <span class="ot">&lt;-</span> paramdf<span class="sc">$</span>af[[i]]</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  fx <span class="ot">&lt;-</span> paramdf<span class="sc">$</span>fx[[i]]</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">hwesim</span>(<span class="at">n =</span> n, <span class="at">af =</span> af, <span class="at">fx =</span> fx)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  pvec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="at">length.out =</span> <span class="dv">3</span>)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(pvec) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;p_chisq&quot;</span>, <span class="st">&quot;p_lratio&quot;</span>, <span class="st">&quot;p_exact&quot;</span>)</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  pvec[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> HardyWeinberg<span class="sc">::</span><span class="fu">HWChisq</span>(<span class="at">X =</span> x, <span class="at">verbose =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>pval</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>  pvec[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> HardyWeinberg<span class="sc">::</span><span class="fu">HWLratio</span>(<span class="at">X =</span> x, <span class="at">verbose =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>pval</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  pvec[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> HardyWeinberg<span class="sc">::</span><span class="fu">HWExact</span>(<span class="at">X =</span> x, <span class="at">verbose =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>pval</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>  pvec</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>paramdf <span class="ot">&lt;-</span> <span class="fu">cbind</span>(paramdf, pmat)</span></code></pre></div></li>
<li><p>Using 8 cores on my laptop, the above took about 20 seconds, which is about 3 times faster than sequential processing.</p></li>
<li><p>There are some small optimizations I could do to improve performance even more. E.g. in the above I am passing around that large data frame <code>paramdf</code> to each new R session.</p>
<ul>
<li>If you are curious on how to solve this, read about using the <a href="https://cran.r-project.org/package=iterators"><code>{iterators}</code></a> in the <a href="https://cran.r-project.org/web/packages/foreach/vignettes/foreach.html"><code>{foreach}</code> vignette</a>.</li>
</ul></li>
<li><p>Side note: The simulation results indicate that the chi-square is not appropriate for small counts for small allele frequencies. The likelihood ratio and exact tests perform similarly.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>paramdf <span class="sc">%&gt;%</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(p_chisq, p_lratio, p_exact, <span class="at">key =</span> <span class="st">&quot;method&quot;</span>, <span class="at">value =</span> <span class="st">&quot;pvalue&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(n, af, fx, method) <span class="sc">%&gt;%</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">power =</span> <span class="fu">mean</span>(pvalue <span class="sc">&lt;</span> <span class="fl">0.05</span>), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">method =</span> <span class="fu">str_remove</span>(method, <span class="st">&quot;p_&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">af =</span> <span class="fu">factor</span>(af), <span class="at">fx =</span> <span class="fu">factor</span>(fx)) <span class="sc">%&gt;%</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">y =</span> power, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(af <span class="sc">~</span> fx) <span class="sc">+</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#E69F00&quot;</span>, <span class="st">&quot;#56B4E9&quot;</span>, <span class="st">&quot;#009E73&quot;</span>))</span></code></pre></div>
<p><img src="09_future_files/figure-html/unnamed-chunk-32-1.png" width="672" style="display: block; margin: auto;" /></p></li>
</ul>
</div>
<div id="bash-notes" class="section level1">
<h1>Bash notes:</h1>
<ul>
<li><p>You can see if your R processes are running by using <a href="https://en.wikipedia.org/wiki/Top_(software)"><code>top</code></a> in Bash (not for Windows).</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">top</span></span></code></pre></div></li>
<li><p>It will open a running list of processes, and if your parallelization is successful you should see multiple processes called <code>R</code>.</p></li>
<li><p>You can exit the <code>top</code> list by typing <code>q</code>.</p></li>
<li><p>If you want to be fancy, you can try downloading <a href="https://en.wikipedia.org/wiki/Htop"><code>htop</code></a>.</p></li>
</ul>
</div>
<div id="new-functions" class="section level1">
<h1>New Functions</h1>
<ul>
<li><code>future::availableCores()</code>: See how many cores are available.</li>
<li><code>future::plan()</code>: Set the evaluation plan (<code>"sequential"</code>/<code>"multisession"</code>/<code>"multicore"</code>).</li>
<li><code>furrr::map()</code> and variants.</li>
<li><code>doFuture::registerDoFuture()</code>: Register a parallel backend so that <code>{foreach}</code> knows how to use <code>%dopar%</code>.</li>
<li><code>doRNG::registerDoRNG()</code>: Register a parallel backend that is reproducible when using <code>%dopar%</code>.</li>
<li><code>foreach()</code> used with <code>%do%</code> or <code>%dopar%</code>.</li>
</ul>
</div>

<!DOCTYPE html>
<hr>
<a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2132247"><img src="https://dcgerard.github.io/advancedr/nsf_logo.png" alt="National Science Foundation Logo" height="48px"/></a>
<a href="https://www.american.edu/cas/mathstat/"><img src="https://dcgerard.github.io/advancedr/au_logo.png" alt="American University Logo" height="48px"/></a>
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
